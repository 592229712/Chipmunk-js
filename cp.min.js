(function(){Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};if(typeof a=="undefined")var a={};typeof window=="object"&&(window.cp=a);var b=function(a,b){if(!a)throw new Error("Assertion failed: "+b)},c=function(a,b){!a&&console&&console.warn&&console.warn("ASSERTION FAILED: "+b)},d=function(a,b){return a+" "+b},e=0,f=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=C,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d,e++},g=function(a,b){return a<b?a:b},h=function(a,b){return a>b?a:b},i,j;typeof window=="object"&&window.navigator.userAgent.indexOf("Firefox")>-1?(i=Math.min,j=Math.max):(i=g,j=h);var k=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b){a[c]=a[a.length-1],a.length--;return}},l=a.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+S(d))},m=a.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},n=a.momentForSegment=function(a,b,c){var d=F(I(c,b)),e=K(H(b,c),.5);return a*(d*d/12+S(e))},o=a.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*Y(a,b))},p=a.momentForPoly=function(a,b,c){var d=0,e=0,f=b.length;for(var g=0;g<f;g+=2){var h=b[g]+c.x,i=b[g+1]+c.y,j=b[(g+2)%f]+c.x,k=b[(g+3)%f]+c.y,l=M(j,k,h,i),m=E(h,i,h,i)+E(h,i,j,k)+E(j,k,j,k);d+=l*m,e+=l}return a*d/(6*e)},q=a.areaForPoly=function(a){throw new Error("Not updated for flat verts");var b},r=a.centroidForPoly=function(a){throw new Error("Not updated for flat verts");var b,c},s=a.recenterPoly=function(a){throw new Error("Not updated for flat verts");var b},t=a.momentForBox=function(a,b,c){return a*(b*b+c*c)/12},u=a.momentForBox2=function(a,b){return width=b.r-b.l,height=b.t-b.b,offset=K([b.l+b.r,b.b+b.t],.5),t(a,width,height)+a*S(offset)},v=function(a,b,c){return i(j(a,b),c)},w=function(a){return j(0,i(a,1))},x=function(a,b,c){return a*(1-c)+b*c},y=function(a,b,c){return a+v(b-a,-c,c)},z=0,A={},B=a.Vect=function(a,b){this.x=a,this.y=b,z++};a.v={};var C=new B(0,0),D=a.v.dot=function(a,b){return a.x*b.x+a.y*b.y},E=function(a,b,c,d){return a*c+b*d},F=a.v.length=function(a){return Math.sqrt(D(a,a))},G=a.v.eql=function(a,b){return a.x===b.x&&a.y===b.y},H=a.v.add=function(a,b){return new B(a.x+b.x,a.y+b.y)};B.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var I=a.v.sub=function(a,b){return new B(a.x-b.x,a.y-b.y)};B.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var J=a.v.neg=function(a){return new B(-a.x,-a.y)};B.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var K=a.v.mult=function(a,b){return new B(a.x*b,a.y*b)};B.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var L=a.v.cross=function(a,b){return a.x*b.y-a.y*b.x},M=function(a,b,c,d){return a*d-b*c},N=a.v.perp=function(a){return new B(-a.y,a.x)},O=a.v.pvrperp=function(a){return new B(a.y,-a.x)},P=a.v.project=function(a,b){return K(b,D(a,b)/b.lengthsq())};B.prototype.project=function(a){return this.mult(D(this,a)/a.lengthsq()),this};var Q=a.v.rotate=function(a,b){return new B(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};B.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this};var R=a.v.unrotate=function(a,b){return new B(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},S=a.v.lengthsq=function(a){return D(a,a)},T=a.v.lerp=function(a,b,c){return H(K(a,1-c),K(b,c))},U=a.v.normalize=function(a){return K(a,1/F(a))},V=a.v.normalize_safe=function(a){return a.x===0&&a.y===0?C:U(a)},W=a.v.clamp=function(a,b){return D(a,a)>b*b?K(U(a),b):a},X=a.v.lerpconst=function(a,b,c){return H(a,W(I(b,a),c))},Y=a.v.dist=function(a,b){return F(I(a,b))},Z=a.v.distsq=function(a,b){return S(I(a,b))},$=a.v.near=function(a,b,c){return Z(a,b)<c*c},_=a.v.slerp=function(a,b,c){var d=Math.acos(D(a,b));if(d){var e=1/Math.sin(d);return H(K(a,Math.sin((1-c)*d)*e),K(b,Math.sin(c*d)*e))}return a},ba=a.v.slerpconst=function(a,b,c){var d=Math.acos(D(a,b));return _(a,b,i(c,d)/d)},bb=a.v.forangle=function(a){return new B(Math.cos(a),Math.sin(a))},bc=a.v.toangle=function(a){return Math.atan2(a.y,a.x)},bd=a.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"},be=0,bf=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d,be++},bg=function(a,b){return new bf(a.x-b,a.y-b,a.x+b,a.y+b)},bh=function(a,b){return a.l<=b.r&&b.l<=a.r&&a.b<=b.t&&b.b<=a.t},bi=function(a,b,c,d,e){return a.l<=d&&b<=a.r&&a.b<=e&&c<=a.t},bj=function(a,b){return a.l<=b.l&&a.r>=b.r&&a.b<=b.b&&a.t>=b.t},bk=function(a,b){return a.l<=b.x&&a.r>=b.x&&a.b<=b.y&&a.t>=b.y},bl=function(a,b,c,d,e){return a<=e.x&&c>=e.x&&b<=e.y&&d>=e.y},bm=function(a,b){return new bf(i(a.l,b.l),i(a.b,b.b),j(a.r,b.r),j(a.t,b.t))},bn=function(a,b){return new bf(i(a.l,b.x),i(a.b,b.y),j(a.r,b.x),j(a.t,b.y))},bo=function(a){return(a.r-a.l)*(a.t-a.b)},bp=function(a,b){return(j(a.r,b.r)-i(a.l,b.l))*(j(a.t,b.t)-i(a.b,b.b))},bq=function(a,b,c,d,e){return(j(a.r,d)-i(a.l,b))*(j(a.t,e)-i(a.b,c))},br=function(a,b,c){var d=1/(c.x-b.x),e=a.l==b.x?-Infinity:(a.l-b.x)*d,f=a.r==b.x?Infinity:(a.r-b.x)*d,g=n(e,f),h=o(e,f),i=1/(c.y-b.y),j=a.b==b.y?-Infinity:(a.b-b.y)*i,k=a.t==b.y?Infinity:(a.t-b.y)*i,l=n(j,k),m=o(j,k);if(l<=h&&g<=m){var n=o(g,l),o=n(h,m);if(0<=o&&n<=1)return o(n,0)}return Infinity},bs=function(a,b,c){return br(a,b,c)!=Infinity},bt=function(a,b){var c=i(j(a.l,b.x),a.r),d=i(j(a.b,b.y),a.t);return new B(c,d)},bu=function(a,b){var c=Math.abs(a.r-a.l),d=(b.x-a.l)%c,e=d>0?d:d+c,f=Math.abs(a.t-a.b),g=(b.y-a.b)%f,h=g>0?g:g+f;return new B(e+a.l,h+a.b)},bv=0,bw=0,bx=-1;a.resetShapeIdCounter=function(){bv=0};var by=a.Shape=function(a){this.body=a,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=bv++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=C,this.collision_type=0,this.group=0,this.layers=bx,this.space=null,this.collisionCode=this.collisionCode};by.prototype.setElasticity=function(a){this.e=a},by.prototype.setFriction=function(a){this.body.activate(),this.u=a},by.prototype.setLayers=function(a){this.body.activate(),this.layers=a},by.prototype.active=function(){return this.prev||this.body.shapeList.length>0&&this.body.shapeList[0]===this},by.prototype.setBody=function(a){b(!this.active(),"You cannot change the body on an active shape. You must remove the shape, then "),this.body=a},by.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},by.prototype.update=function(a,c){b(!isNaN(c.x),"Rotation is NaN"),b(!isNaN(a.x),"Position is NaN"),this.cacheData(a,c)};var bz=function(a){this.shape=a,this.d=Infinity,this.n=C},bA=function(a,b,c){this.shape=a,this.t=b,this.n=c},bB=a.CircleShape=function(a,b,c){this.c=this.tc=c,this.r=b,this.type="circle",by.call(this,a)};bB.prototype=Object.create(by.prototype),bB.prototype.cacheData=function(a,b){var c=this.tc=Q(this.c,b).add(a),d=this.r;this.bb_l=c.x-d,this.bb_b=c.y-d,this.bb_r=c.x+d,this.bb_t=c.y+d},bB.prototype.pointQuery=function(a){var b=I(a,this.tc),c=S(b),d=this.r;if(c<d*d){var e=new bz(this),f=fsqrt(c);return e.d=d-f,e.n=K(b,1/f),e}};var bC=function(a,b,c,d,e,f){d=I(d,b),e=I(e,b);var g=D(d,d)-2*D(d,e)+D(e,e),h=-2*D(d,d)+2*D(d,e),i=D(d,d)-c*c,j=h*h-4*g*i;if(j>=0){var k=(-h-Math.sqrt(j))/(2*g);if(0<=k&&k<=1)return new bA(a,k,U(T(d,e,k)))}};bB.prototype.segmentQuery=function(a,b){return bC(this,this.tc,this.r,a,b)};var bD=a.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=N(U(I(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=C,this.b_tangent=C,this.type="segment",by.call(this,a)};bD.prototype=Object.create(by.prototype),bD.prototype.cacheData=function(a,b){this.ta=H(a,Q(this.a,b)),this.tb=H(a,Q(this.b,b)),this.tn=Q(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x),this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g,this.bb_b=e-g,this.bb_r=d+g,this.bb_t=f+g},bD.prototype.pointQuery=function(a){if(!bl(this.bb_l,this.bb_b,this.bb_r,this.bb_t,a))return;var b=this.ta,c=this.tb,d=I(c,b),e=fclamp01(D(d,I(a,b))/S(d)),f=H(b,K(d,e)),g=I(a,f),h=S(g),i=this.r;if(h<i*i){var j=new bz(this),k=Math.sqrt(h);return j.d=i-k,j.n=K(g,1/k),j}},bD.prototype.segmentQuery=function(a,b){var c=this.tn,d=D(I(this.ta,a),c),e=this.r,f=d>0?J(c):c,g=I(K(f,e),a),h=H(this.ta,g),i=H(this.tb,g),j=I(b,a);if(L(j,h)*L(j,i)<=0){var k=d+(d>0?-e:e),l=-k,m=D(j,c)-k;if(l*m<0)return{shape:this,t:l/(l-m),n:f}}else if(e!=0){var n=bC(this,this.ta,this.r,a,b),o=bC(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},bD.prototype.setNeighbors=function(a,b){this.a_tangent=I(a,this.a),this.b_tangent=I(b,this.b)},bD.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=N(U(I(b,a)))},a.segmentQueryHitPoint=function(a,b,c){return T(a,b,c.t)},a.segmentQueryHitDist=function(a,b,c){return Y(a,b)*c.t};var bE=function(a){var b=a.length;for(var c=0;c<b;c+=2){var d=a[c],e=a[c+1],f=a[(c+2)%b],g=a[(c+3)%b],h=a[(c+4)%b],i=a[(c+5)%b];if(M(f-d,g-e,h-f,i-g)>0)return!1}return!0},bF=a.PolyShape=function(a,c,d){b(c.length>=4,"Polygons require some verts"),b(typeof c[0]=="number","Polygon verticies should be specified in a flattened list"),b(bE(c),"Polygon is concave or has a reversed winding."),this.setVerts(c,d),this.type="poly",by.call(this,a)};bF.prototype=Object.create(by.prototype);var bG=function(a,b){this.n=a,this.d=b};bF.prototype.setVerts=function(a,b){var c=a.length,d=c>>1;this.verts=new Array(c),this.tVerts=new Array(c),this.axes=new Array(d),this.tAxes=new Array(d);for(var e=0;e<c;e+=2){var f=a[e]+b.x,g=a[e+1]+b.y,h=a[(e+2)%c]+b.x,i=a[(e+3)%c]+b.y,j=U(N(new B(h-f,i-g)));this.verts[e]=f,this.verts[e+1]=g,this.axes[e>>1]=new bG(j,E(j.x,j.y,f,g)),this.tAxes[e>>1]=new bG(new B(0,0),0)}};var bH=a.BoxShape=function(a,b,c){var d=b/2,e=c/2;return bI(a,new bf(-d,-e,d,e))},bI=a.BoxShape2=function(a,b){var c=[b.l,b.b,b.l,b.t,b.r,b.t,b.r,b.b];return new bF(a,c,C)};bF.prototype.transformVerts=function(a,b){var c=this.verts,d=this.tVerts,e=Infinity,f=-Infinity,g=Infinity,h=-Infinity;for(var k=0;k<c.length;k+=2){var l=c[k],m=c[k+1],n=a.x+l*b.x-m*b.y,o=a.y+l*b.y+m*b.x;d[k]=n,d[k+1]=o,e=i(e,n),f=j(f,n),g=i(g,o),h=j(h,o)}this.bb_l=e,this.bb_b=g,this.bb_r=f,this.bb_t=h},bF.prototype.transformAxes=function(a,b){var c=this.axes,d=this.tAxes;for(var e=0;e<c.length;e++){var f=Q(c[e].n,b);d[e].n=f,d[e].d=D(a,f)+c[e].d}},bF.prototype.cacheData=function(a,b){this.transformAxes(a,b),this.transformVerts(a,b)},bF.prototype.pointQuery=function(a){if(!bl(this.bb_l,this.bb_b,this.bb_r,this.bb_t,a))return;var b=new bz(this),c=this.tAxes;for(var d=0;d<c.length;d++){var e=c[d].n,f=c[d].d-D(e,a);if(f<0)return;f<b.d&&(b.d=f,b.n=e)}return b},bF.prototype.segmentQuery=function(a,b){var c=this.tAxes,d=this.tVerts,e=c.length,f=e*2;for(var g=0;g<e;g++){var h=c[g].n,i=D(a,h);if(c[g].d>i)continue;var j=D(b,h),k=(c[g].d-i)/(j-i);if(k<0||1<k)continue;var l=T(a,b,k),m=-L(h,l),n=-M(h.x,h.y,d[g],d[g+1]),o=-M(h.x,h.y,d[(g+2)%f],d[(g+3)%f]);if(n<=m&&m<=o)return new bA(this,k,h)}},bF.prototype.valueOnAxis=function(a,b){var c=this.tVerts,d=E(a.x,a.y,c[0],c[1]);for(var e=2;e<c.length;e+=2)d=i(d,E(a.x,a.y,c[e],c[e+1]));return d-b},bF.prototype.containsVert=function(a,b){var c=this.tAxes;for(var d=0;d<c.length;d++){var e=c[d].n,f=E(e.x,e.y,a,b)-c[d].d;if(f>0)return!1}return!0},bF.prototype.containsVertPartial=function(a,b,c){var d=this.tAxes;for(var e=0;e<d.length;e++){var c=d[e].n;if(D(c,c)<0)continue;var f=E(c.x,c.y,a,b)-d[e].d;if(f>0)return!1}return!0};var bJ=a.Body=function(a,b){bJ.prototype.velocity_func=bJ.prototype.updateVelocity,bJ.prototype.position_func=bJ.prototype.updatePosition,this.p=new B(0,0),this.vx=this.vy=0,this.f=new B(0,0),this.w=0,this.t=0,this.v_limit=Infinity,this.w_limit=Infinity,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.rot=new B(0,0),this.setAngle(0)},bK=function(){return body=new bJ(Infinity,Infinity),body.nodeIdleTime=Infinity,body};if(typeof DEBUG!="undefined"&&DEBUG){var bL=function(a,c){b(a.x==a.x&&a.y==a.y,c)},bM=function(a,c){b(Math.abs(a.x)!==Infinity&&Math.abs(a.y)!==Infinity,c)},bN=function(a,b){bL(a,b),bM(a,b)};bJ.prototype.sanityCheck=function(){b(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),b(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),bN(this.p,"Body's position is invalid."),bN(this.f,"Body's force is invalid."),b(this.vx===this.vx&&Math.abs(this.vx)!==Infinity,"Body's velocity is invalid."),b(this.vy===this.vy&&Math.abs(this.vy)!==Infinity,"Body's velocity is invalid."),b(this.a===this.a&&Math.abs(this.a)!==Infinity,"Body's angle is invalid."),b(this.w===this.w&&Math.abs(this.w)!==Infinity,"Body's angular velocity is invalid."),b(this.t===this.t&&Math.abs(this.t)!==Infinity,"Body's torque is invalid."),bN(this.rot,"Internal error: Body's rotation vector is invalid."),b(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),b(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else bJ.prototype.sanityCheck=function(){};bJ.prototype.isSleeping=function(){return this.nodeRoot!==null},bJ.prototype.isStatic=function(){return this.nodeIdleTime===Infinity},bJ.prototype.isRogue=function(){return this.space===null},bJ.prototype.setMass=function(a){b(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},bJ.prototype.setMoment=function(a){b(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},bJ.prototype.addShape=function(a){this.shapeList.push(a)},bJ.prototype.removeShape=function(a){k(this.shapeList,a)};var bO=function(a,b,c){return a==c?a.next(b):(a.a===b?a.next_a=bO(a.next_a,b,c):a.next_b=bO(a.next_b,b,c),a)};bJ.prototype.removeConstraint=function(a){this.constraintList=bO(this.constraintList,this,a)},bJ.prototype.setPos=function(a){this.activate(),this.sanityCheck(),this.p=a},bJ.prototype.setVelocity=function(a){this.activate(),this.vx=a.x,this.vy=a.y},bJ.prototype.setAngleInternal=function(a){b(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN"),this.a=a,this.rot.x=Math.cos(a),this.rot.y=Math.sin(a)},bJ.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},bJ.prototype.updateVelocity=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c,e=this.vy*b+(a.y+this.f.y*this.m_inv)*c,f=this.v_limit,g=d*d+e*e,h=g>f*f?f/Math.sqrt(len):1;this.vx=d*h,this.vy=e*h;var i=this.w_limit;this.w=v(this.w*b+this.t*this.i_inv*c,-i,i),this.sanityCheck()},bJ.prototype.updatePosition=function(a){this.p.x+=(this.vx+this.v_biasx)*a,this.p.y+=(this.vy+this.v_biasy)*a,this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},bJ.prototype.resetForces=function(){this.activate(),this.f=new B(0,0),this.t=0},bJ.prototype.applyForce=function(a,b){this.activate(),this.f=H(this.f,a),this.t+=L(b,a)},bJ.prototype.applyImpulse=function(a,b){this.activate(),cR(this,a.x,a.y,b)},bJ.prototype.getVelAtPoint=function(a){return H(new B(this.vx,this.vy),K(N(a),body.w))},bJ.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(I(a,body.p))},bJ.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(Q(a,body.rot))},bJ.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;b<c;b++)a(this.shapeList[b])},bJ.prototype.eachConstraint=function(a){var b=this.constraintList;while(b){var c=b.next(body);a(b),b=c}},bJ.prototype.eachArbiter=function(a){var b=this.arbiterList;while(b){var c=b.next(body);b.swappedColl=this===b.body_b,a(b),b=c}},bJ.prototype.local2World=function(a){return H(this.p,Q(a,this.rot))},bJ.prototype.world2Local=function(a){return R(I(a,this.p),this.rot)},bJ.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var bP=a.SpatialIndex=function(a){this.staticIndex=a,a&&(b(!a.dynamicIndex,"This static index is already associated with a dynamic index."),a.dynamicIndex=this)};bP.prototype.collideStatic=function(a,b){if(a.count>0){var c=a.query;this.each(function(a){c(a,new bf(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var bQ=a.BBTree=function(a){bP.call(this,a),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.stamp=0};bQ.prototype=Object.create(bP.prototype);var bR=0,bS=function(a,b,c){this.obj=null,this.bb_l=i(b.bb_l,c.bb_l),this.bb_b=i(b.bb_b,c.bb_b),this.bb_r=j(b.bb_r,c.bb_r),this.bb_t=j(b.bb_t,c.bb_t),this.parent=null,this.setA(b),this.setB(c),bR++},bT=0,bU=function(a,b){this.obj=b,a.getBB(b,this),this.parent=null,this.stamp=1,this.pairs=null,bT++};bQ.prototype.getBB=function(a,b){var c=this.velocityFunc;if(c){var d=.1,e=(a.bb_r-a.bb_l)*d,f=(a.bb_t-a.bb_b)*d,g=K(c(a),.1);b.bb_l=a.bb_l+i(-e,g.x),b.bb_b=a.bb_b+i(-f,g.y),b.bb_r=a.bb_r+j(e,g.x),b.bb_t=a.bb_t+j(f,g.y)}else b.bb_l=a.bb_l,b.bb_b=a.bb_b,b.bb_r=a.bb_r,b.bb_t=a.bb_t},bQ.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},bQ.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var bV=function(a,b){this.a=a,this.b=b},bW=function(a,b){this.prev=null,this.next=b,this.leaf=a};bW.prototype.unlink=function(){var a=this.next,b=this.prev;a&&(a.a.leaf==this.leaf?a.a.prev=b:a.b.prev=b),b?b.a.leaf==this.leaf?b.a.next=a:b.b.next=a:this.leaf.pairs=a},bU.prototype.clearPairs=function(a){var b=this.pairs,c;this.pairs=null;while(b)b.a.leaf==this?(c=b.a.next,b.b.unlink(),b=c):(c=b.b.next,b.a.unlink(),b=c)};var bX=function(a,b,c){var d=a.pairs,e=b.pairs,f=new bV(new bW(a,d),new bW(b,e));a.pairs=b.pairs=f,d&&(d.a.leaf==a?d.a.prev=f:d.b.prev=f),e&&(e.a.leaf==b?e.a.prev=f:e.b.prev=f)};bS.prototype.setA=function(a){this.A=a,a.parent=this},bS.prototype.setB=function(a){this.B=a,a.parent=this},bU.prototype.isLeaf=!0,bS.prototype.isLeaf=!1,bS.prototype.otherChild=function(a){return this.A==a?this.B:this.A},bS.prototype.replaceChild=function(a,b,d){c(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?this.setA(b):this.setB(b);for(var e=this;e;e=e.parent){var f=e.A,g=e.B;e.bb_l=i(f.bb_l,g.bb_l),e.bb_b=i(f.bb_b,g.bb_b),e.bb_r=j(f.bb_r,g.bb_r),e.bb_t=j(f.bb_t,g.bb_t)}},bS.prototype.bbArea=bU.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var bY=function(a,b){return(j(a.bb_r,b.bb_r)-i(a.bb_l,b.bb_l))*(j(a.bb_t,b.bb_t)-i(a.bb_b,b.bb_b))},bZ=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+b.bb_t-b.bb_b-b.bb_t)},b$=function(a,b,c){if(a==null)return b;if(a.isLeaf)return new bS(c,b,a);var d=a.B.bbArea()+bY(a.A,b),e=a.A.bbArea()+bY(a.B,b);return d===e&&(d=bZ(a.A,b),e=bZ(a.B,b)),e<d?a.setB(b$(a.B,b,c)):a.setA(b$(a.A,b,c)),a.bb_l=i(a.bb_l,b.bb_l),a.bb_b=i(a.bb_b,b.bb_b),a.bb_r=j(a.bb_r,b.bb_r),a.bb_t=j(a.bb_t,b.bb_t),a};bS.prototype.intersectsBB=bU.prototype.intersectsBB=function(a,b){return a.bb_l<=b.r&&b.l<=a.bb_r&&a.bb_b<=b.t&&b.b<=a.bb_t};var b_=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(b_(a.A,b,c),b_(a.B,b,c)))},ca=function(a,b,c){var d=1/(c.x-b.x),e=a.bb_l==b.x?-Infinity:(a.bb_l-b.x)*d,f=a.bb_r==b.x?Infinity:(a.bb_r-b.x)*d,g=n(e,f),h=o(e,f),i=1/(c.y-b.y),j=a.bb_b==b.y?-Infinity:(a.bb_b-b.y)*i,k=a.bb_t==b.y?Infinity:(a.bb_t-b.y)*i,l=n(j,k),m=o(j,k);if(l<=h&&g<=m){var n=o(g,l),o=n(h,m);if(0<=o&&n<=1)return o(n,0)}return Infinity},cb=function(a,b,c,d,e){if(a.isLeaf)return e(a.obj);var f=ca(a.A,b,c),g=ca(a.B,b,c);return f<g?(f<d&&(d=i(d,cb(a.A,b,c,d,e,data))),g<d&&(d=i(d,cb(a.B,b,c,d,e,data)))):(g<d&&(d=i(d,cb(a.B,b,c,d,e,data))),f<d&&(d=i(d,cb(a.A,b,c,d,e,data)))),d},cc=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,e}return d.parent.replaceChild(d,d.otherChild(b),c),a},cd=function(a,b){return a.bb_l<=b.bb_r&&b.bb_l<=a.bb_r&&a.bb_b<=b.bb_t&&b.bb_b<=a.bb_t},ce=function(a,b,c,d,e){cd(b,a)&&(a.isLeaf?c?bX(b,a,d):(a.stamp<b.stamp&&bX(a,b,d),e&&e(b.obj,a.obj)):(ce(a.A,b,c,d,e),ce(a.B,b,c,d,e)))},cf=function(a,b,c,d){if(a.stamp==b.getStamp()){c&&ce(c,a,!1,b,d);for(var e=a;e.parent;e=e.parent)e==e.parent.A?ce(e.parent.B,a,!0,b,d):ce(e.parent.A,a,!1,b,d)}else{var f=a.pairs;while(f)a==f.b.leaf?(d&&d(f.a.leaf.obj,a.obj),f=f.b.next):f=f.a.next}},cg=function(a,b,c,d){a.isLeaf?cf(a,b,c,d):(cg(a.A,b,c,d),cg(a.B,b,c,d))};bU.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t},bU.prototype.update=function(a){var b=a.root,c=this.obj;return this.containsObj(c)?!1:(a.getBB(this.obj,this),b=cc(b,this,a),a.root=b$(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},bU.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&ce(c,this,!0,b,null)}else{var d=a.staticIndex.root;cf(this,a,d,null)}},bQ.prototype.insert=function(a,b){var c=new bU(this,a);this.leaves[b]=c,this.root=b$(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},bQ.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=cc(this.root,c,this),this.count--,c.clearPairs(this)},bQ.prototype.contains=function(a,b){return this.leaves[b]!=null};var ch=function(a,b){};bQ.prototype.reindexQuery=function(a){if(!this.root)return;var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;cg(this.root,this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()},bQ.prototype.reindex=function(){this.reindexQuery(ch)},bQ.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},bQ.prototype.pointQuery=function(a,b){this.root&&b_(this.root,new bf(a.x,a.y,a.x,a.y),b)},bQ.prototype.segmentQuery=function(a,b,c,d){this.root&&cb(this,a,b,c,d)},bQ.prototype.query=function(a,b){this.root&&b_(this.root,a,b)},bQ.prototype.count=function(){return this.count},bQ.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b].obj)};var ci=function(a,b,c,d,e){return(j(a.bb_r,d)-i(a.bb_l,b))*(j(a.bb_t,e)-i(a.bb_b,c))},cj=function(a,b,c,d){if(d==1)return b[c];if(d==2)return new bS(a,b[c],b[c+1]);var e=b[c],f=e.bb_l,g=e.bb_b,h=e.bb_r,k=e.bb_t,l=c+d;for(var m=c+1;m<l;m++)e=b[m],f=i(f,e.bb_l),g=i(g,e.bb_b),h=j(h,e.bb_r),k=j(k,e.bb_t);var n=h-f>k-g,o=new Array(d*2);if(n)for(var m=c;m<l;m++)o[2*m+0]=b[m].bb_l,o[2*m+1]=b[m].bb_r;else for(var m=c;m<l;m++)o[2*m+0]=b[m].bb_b,o[2*m+1]=b[m].bb_t;o.sort(function(a,b){return a-b});var p=(o[d-1]+o[d])*.5,q=f,r=g,s=h,t=k,u=f,v=g,w=h,x=k;n?s=u=p:t=v=p;var y=l;for(var z=c;z<y;){var e=b[z];ci(e,u,v,w,x)<ci(e,q,r,s,t)?(y--,b[z]=b[y],b[y]=e):z++}if(y==d){var e=null;for(var m=c;m<l;m++)e=b$(e,b[m],a);return e}return NodeNew(a,cj(a,b,c,y-c),cj(a,b,y,l-y))};bQ.prototype.optimize=function(){var a=new Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];this.root=cj(tree,a,a.length)};var ck=function(a,b){!a.isLeaf&&b<=10&&(ck(a.a,b+1),ck(a.b,b+1));var c="";for(var d=0;d<b;d++)c+=" "};bQ.prototype.log=function(){this.root&&ck(this.root,0)};var cl=a.CollisionHandler=function(){this.a=this.b=0};cl.prototype.begin=function(a,b){return!0},cl.prototype.preSolve=function(a,b){return!0},cl.prototype.postSolve=function(a,b){},cl.prototype.separate=function(a,b){};var cm=4,cn=function(a,b){this.e=0,this.u=0,this.surface_vr=C,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};cn.prototype.totalImpulse=function(){var a=this.contacts,b=new B(0,0);for(var c=0,d=a.length;c<d;c++){var e=a[c];b.add(K(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()},cn.prototype.totalImpulseWithFriction=function(){var a=this.contacts,b=new B(0,0);for(var c=0,d=a.length;c<d;c++){var e=a[c];b.add((new B(e.jnAcc,e.jtAcc)).rotate(e.n))}return this.swappedColl?b:b.neg()},cn.prototype.totalKE=function(){var a=(1-arb.e)/(1+arb.e),b=0,c=arb.contacts;for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},cn.prototype.ignore=function(){this.state="ignore"},cn.prototype.getA=function(){return this.swappedColl?this.b:this.a},cn.prototype.getB=function(){return this.swappedColl?this.a:this.b},cn.prototype.isFirstContact=function(){return this.state==="first coll"};var co=function(a,b,c){this.point=a,this.normal=b,this.dist=c};cn.prototype.getContactPointSet=function(){var a=new Array(this.contacts.length),b;for(b=0;b<a.length;b++)a[b]=new co(this.contacts[b].p,this.contacts[b].n,this.contacts[b].dist);return a},cn.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?J(b):b},cn.prototype.getPoint=function(a){return this.contacts[a].p},cn.prototype.getDepth=function(a){return this.contacts[a].dist};var cp=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d,d&&(d.body_a===b?d.thread_a_prev=c:d.thread_b_prev=c)};cn.prototype.unthread=function(){cp(this,this.body_a,this.thread_a_prev,this.thread_a_next),cp(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},cn.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;e<this.contacts.length;e++){var f=this.contacts[e];for(var g=0;g<a.length;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=I(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,this.state=="cached"&&(this.state="first coll")},cn.prototype.preStep=function(a,b,c){var d=this.body_a,e=this.body_b;for(var f=0;f<this.contacts.length;f++){var g=this.contacts[f];g.r1=I(g.p,d.p),g.r2=I(g.p,e.p),g.nMass=1/cV(d,e,g.r1,g.r2,g.n),g.tMass=1/cV(d,e,g.r1,g.r2,N(g.n)),g.bias=-c*i(0,g.dist+b)/a,g.jBias=0,g.bounce=cQ(d,e,g.r1,g.r2,g.n)*this.e}},cn.prototype.applyCachedImpulse=function(a){if(this.isFirstContact())return;var b=this.body_a,c=this.body_b;for(var d=0;d<this.contacts.length;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y,h=f*e.jnAcc-g*e.jtAcc,i=f*e.jtAcc+g*e.jnAcc;cS(b,c,e.r1,e.r2,h*a,i*a)}};var cq=0,cr=0;cn.prototype.applyImpulse=function(){cq++;var a=this.body_a,b=this.body_b,c=this.surface_vr,d=this.u;for(var e=0;e<this.contacts.length;e++){cr++;var f=this.contacts[e],g=f.nMass,h=f.n,i=f.r1,k=f.r2,l=b.vx-k.y*b.w-(a.vx-i.y*a.w),m=b.vy+k.x*b.w-(a.vy+i.x*a.w),n=h.x*(b.v_biasx-k.y*b.w_bias-a.v_biasx+i.y*a.w_bias)+h.y*(k.x*b.w_bias+b.v_biasy-i.x*a.w_bias-a.v_biasy),o=E(l,m,h.x,h.y),p=E(l+c.x,m+c.y,-h.y,h.x),q=(f.bias-n)*g,r=f.jBias;f.jBias=j(r+q,0);var s=-(f.bounce+o)*g,t=f.jnAcc;f.jnAcc=j(t+s,0);var u=d*f.jnAcc,w=-p*f.tMass,x=f.jtAcc;f.jtAcc=v(x+w,-u,u);var y=h.x*(f.jBias-r),z=h.y*(f.jBias-r);cT(a,-y,-z,i),cT(b,y,z,k);var A=f.jnAcc-t,B=f.jtAcc-x;cS(a,b,i,k,h.x*A-h.y*B,h.x*B+h.y*A)}},cn.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},cn.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var cs=[],ct=function(a,b,c,d){var e=c+d,g=I(b,a),h=S(g);if(h>=e*e)return;var i=Math.sqrt(h);return new f(H(a,K(g,.5+(c-.5*e)/(i?i:Infinity))),i?K(g,1/i):new B(1,0),i-e,0)},cu=function(a,b){var c=ct(a.tc,b.tc,a.r,b.r);return c?[c]:cs},cv=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=I(d,c),g=w(D(f,I(e,c))/S(f)),h=H(c,K(f,g)),i=ct(e,h,a.r,b.r);if(i){var j=i.n;return g===0&&D(j,b.a_tangent)<0||g===1&&D(j,b.b_tangent)<0?cs:[i]}return cs},cw=0,cx=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;e<b.length;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return cw=d,c},cy=function(a,b,c,e){var g=[],h=a.tVerts;for(var i=0;i<h.length;i+=2){var j=h[i],k=h[i+1];b.containsVertPartial(j,k,J(c))&&g.push(new f(new B(j,k),c,e,d(a.hashid,i)))}var l=b.tVerts;for(var i=0;i<l.length;i+=2){var j=l[i],k=l[i+1];a.containsVertPartial(j,k,c)&&g.push(new f(new B(j,k),c,e,d(b.hashid,i)))}return g},cz=function(a,b,c,e){var g=[],h=a.tVerts;for(var i=0;i<h.length;i+=2){var j=h[i],k=h[i+1];b.containsVert(j,k)&&g.push(new f(new B(j,k),c,e,d(a.hashid,i>>1)))}var l=b.tVerts;for(var i=0;i<l.length;i+=2){var j=l[i],k=l[i+1];a.containsVert(j,k)&&g.push(new f(new B(j,k),c,e,d(b.hashid,i>>1)))}return g.length?g:cy(a,b,c,e)},cA=function(a,b){var c=cx(b,a.tAxes);if(c==-1)return cs;var d=cw,e=cx(a,b.tAxes);if(e==-1)return cs;var f=cw;return d>f?cz(a,b,a.tAxes[c].n,d):cz(a,b,J(b.tAxes[e].n),f)},cB=function(a,b,c){var d=D(b,a.ta)-a.r,e=D(b,a.tb)-a.r;return i(d,e)-c},cC=function(a,b,c,e,g){var h=L(b.tn,b.ta),i=L(b.tn,b.tb),j=K(b.tn,g),k=c.tVerts;for(var l=0;l<k.length;l+=2){var m=k[l],n=k[l+1];if(E(m,n,j.x,j.y)<D(b.tn,b.ta)*g+b.r){var o=M(b.tn.x,b.tn.y,m,n);h>=o&&o>=i&&a.push(new f(new B(m,n),j,e,d(c.hashid,l)))}}},cD=function(a,b){var c=[],e=b.tAxes,g=e.length,h=D(a.tn,a.ta),i=b.valueOnAxis(a.tn,h)-a.r,j=b.valueOnAxis(J(a.tn),-h)-a.r;if(j>0||i>0)return cs;var k=0,l=cB(a,e[0].n,e[0].d);if(l>0)return cs;for(var m=0;m<g;m++){var n=cB(a,e[m].n,e[m].d);if(n>0)return cs;n>l&&(l=n,k=m)}var o=J(e[k].n),p=H(a.ta,K(o,a.r)),q=H(a.tb,K(o,a.r));b.containsVert(p.x,p.y)&&c.push(new f(p,o,l,d(a.hashid,0))),b.containsVert(q.x,q.y)&&c.push(new f(q,o,l,d(a.hashid,1)));if(i>=l||j>=l)i>j?cC(c,a,b,i,1):cC(c,a,b,j,-1);if(c.length===0){var r=k*2,s=b.tVerts,t=new B(s[r],s[r+1]),u;if(u=ct(a.ta,t,a.r,0,c))return[u];if(u=ct(a.tb,t,a.r,0,c))return[u];var v=g*2,w=new B(s[(r+2)%v],s[(r+3)%v]);if(u=ct(a.ta,w,a.r,0,c))return[u];if(u=ct(a.tb,w,a.r,0,c))return[u]}return c},cE=function(a,b){var c=b.tAxes,d=0,e=D(c[0].n,a.tc)-c[0].d-a.r;for(var g=0;g<c.length;g++){var h=D(c[g].n,a.tc)-c[g].d-a.r;if(h>0)return cs;h>e&&(e=h,d=g)}var i=c[d].n,j=b.tVerts,k=j.length,l=d<<1,m=j[l],n=j[l+1],o=j[(l+2)%k],p=j[(l+3)%k],q=M(i.x,i.y,m,n),r=M(i.x,i.y,o,p),s=L(i,a.tc);if(s<r){var t=ct(a.tc,new B(o,p),a.r,0,t);return t?[t]:cs}if(s<q)return[new f(I(a.tc,K(i,a.r+e/2)),J(i),e,0)];var t=ct(a.tc,new B(m,n),a.r,0,t);return t?[t]:cs};bB.prototype.collisionCode=0,bD.prototype.collisionCode=1,bF.prototype.collisionCode=2,bB.prototype.collisionTable=[cu,cv,cE],bD.prototype.collisionTable=[null,function(a,a){return cs},cD],bF.prototype.collisionTable=[null,null,cA];var cF=a.collideShapes=function(a,c){return b(a.collisionCode<=c.collisionCode,"Collided shapes must be sorted by type"),a.collisionTable[c.collisionCode](a,c)},cG=new cl,cH=a.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new bQ(null),this.activeShapes=new bQ(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=cG,this.postStepCallbacks=[],this.iterations=10,this.gravity=C,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=Infinity,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new bJ(Infinity,Infinity),this.staticBody.nodeIdleTime=Infinity,this.collideShapes=this.makeCollideShapes()};cH.prototype.isLocked=function(){return this.locked};var cI=function(a){b(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};cH.prototype.addCollisionHandler=function(a,b,c,e,f,g){cI(this),this.removeCollisionHandler(a,b);var h=new cl;h.a=a,h.b=b,c&&(h.begin=c),e&&(h.preSolve=e),f&&(h.postSolve=f),g&&(h.separate=g),this.collisionHandlers[d(a,b)]=h},cH.prototype.removeCollisionHandler=function(a,b){cI(this),delete this.collisionHandlers[d(a,b)]},cH.prototype.setDefaultCollisionHandler=function(a,b,c,d){cI(this);var e=new cl;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},cH.prototype.lookupHandler=function(a,b){return this.collisionHandlers[d(a,b)]||this.defaultHandler},cH.prototype.addShape=function(a){var c=a.body;return c.isStatic()?this.addStaticShape(a):(b(!a.space,"This shape is already added to a space and cannot be added to another."),cI(this),c.activate(),c.addShape(a),a.update(c.p,c.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},cH.prototype.addStaticShape=function(a){b(!a.space,"This shape is already added to a space and cannot be added to another."),cI(this);var c=a.body;return c.addShape(a),a.update(c.p,c.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},cH.prototype.addBody=function(a){return b(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),b(!a.space,"This body is already added to a space and cannot be added to another."),cI(this),this.bodies.push
(a),a.space=this,a},cH.prototype.addConstraint=function(a){b(!a.space,"This shape is already added to a space and cannot be added to another."),cI(this);var c=a.a,d=a.b;return c.activate(),d.activate(),this.constraints.push(a),a.next_a=c.constraintList,c.constraintList=a,a.next_b=d.constraintList,d.constraintList=a,a.space=this,a},cH.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];if(a===d.body_a&&(b===d.a||b===null)||a===d.body_b&&(b===d.b||b===null))b&&d.state!=="cached"&&d.callSeparate(this),d.unthread(),k(this.arbiters,d),delete this.cachedArbiters[c]}},cH.prototype.removeShape=function(a){var c=a.body;c.isStatic()?this.removeStaticShape(a):(b(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),cI(this),c.activate(),c.removeShape(a),this.filterArbiters(c,a),this.activeShapes.remove(a,a.hashid),a.space=null)},cH.prototype.removeStaticShape=function(a){b(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),cI(this);var c=a.body;c.isStatic()&&c.activateStatic(a),c.removeShape(a),this.filterArbiters(c,a),this.staticShapes.remove(a,a.hashid),a.space=null},cH.prototype.removeBody=function(a){b(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),cI(this),a.activate(),k(this.bodies,a),a.space=null},cH.prototype.removeConstraint=function(a){b(space.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),cI(this),a.a.activate(),a.b.activate(),k(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},cH.prototype.containsShape=function(a){return a.space===this},cH.prototype.containsBody=function(a){return a.space==this},cH.prototype.containsConstraint=function(a){return a.space==this},cH.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[d(a.a.hashid,a.b.hashid)],k(this.arbiters,a)},cH.prototype.eachBody=function(a){this.lock();var b=this.bodies;for(var c=0;c<b.length;c++)a(b[c]);var d=this.sleepingComponents;for(var c=0;c<d.length;c++){var e=d[c],f=e;while(f){var g=f.nodeNext;a(f),f=g}}this.unlock(!0)},cH.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},cH.prototype.eachConstraint=function(a){this.lock();var b=this.constraints;for(var c=0;c<b.length;c++)a(b[c]);this.unlock(!0)},cH.prototype.reindexStatic=function(){b(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},cH.prototype.reindexShape=function(a){b(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var c=a.body;a.update(c.p,c.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},cH.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},cH.prototype.useSpatialHash=function(a,b){throw new Error("Spatial Hash not yet implemented!");var c,d},cH.prototype.activateBody=function(a){b(!a.isRogue(),"Internal error: Attempting to activate a rogue body.");if(this.locked)this.rousedBodies.indexOf(a)===-1&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var c=0;c<a.shapeList.length;c++){var e=a.shapeList[c];this.staticShapes.remove(e,e.hashid),this.activeShapes.insert(e,e.hashid)}for(var f=a.arbiterList;f;f=f.next(a)){var g=f.body_a;if(a===g||g.isStatic()){var h=f.a,i=f.b;this.cachedArbiters[d(h.hashid,i.hashid)]=f,f.stamp=this.stamp,f.handler=this.lookupHandler(h.collision_type,i.collision_type),this.arbiters.push(f)}}for(var j=a.constraintList;j;j=j.nodeNext){var g=j.a;(a===g||g.isStatic())&&this.constraints.push(j)}}},cH.prototype.deactivateBody=function(a){b(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),k(this.bodies,a);for(var c=0;c<a.shapeList.length;c++){var d=a.shapeList[c];this.activeShapes.remove(d,d.hashid),this.staticShapes.insert(d,d.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;(a===f||f.isStatic())&&this.uncacheArbiter(e)}for(var g=a.constraintList;g;g=g.nodeNext){var f=g.a;(a===f||f.isStatic())&&k(this.constraints,g)}};var cJ=function(a){return a?a.nodeRoot:null},cK=function(a){if(!a||!a.isSleeping(a))return;b(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");var c=a.space,d=a;while(d){var e=d.nodeNext;d.nodeIdleTime=0,d.nodeRoot=null,d.nodeNext=null,c.activateBody(d),d=e}k(c.sleepingComponents,a)};bJ.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,cK(cJ(this)))},bJ.prototype.activateStatic=function(a){b(body.isStatic(this),"Body.activateStatic() called on a non-static body.");for(var c=this.arbiterList;c;c=c.next(this))(!a||a==c.a||a==c.b)&&(c.body_a==this?c.body_b:c.body_a).activate()},bJ.prototype.pushArbiter=function(a){c((a.body_a===this?a.thread_a_next:a.thread_b_next)===null,"Internal Error: Dangling contact graph pointers detected. (A)"),c((a.body_a===this?a.thread_a_prev:a.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;c(b===null||(b.body_a===this?b.thread_a_prev:b.thread_b_prev)===null,"Internal Error: Dangling contact graph pointers detected. (C)"),b&&(a.body_a===this?a.thread_a_next=b:a.thread_b_next=b,b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a),this.arbiterList=a};var cL=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},cM=function(a,b){if(!b.isRogue()){var d=cJ(b);if(d==null){cL(a,b);for(var e=b.arbiterList;e;e=e.next(b))cM(a,b==e.body_a?e.body_b:e.body_a);for(var f=b.constraintList;f;f=f.nodeNext)cM(a,b==f.a?f.b:f.a)}else c(d===a,"Internal Error: Inconsistency detected in the contact graph.")}},cN=function(a,b){for(var c=a;c;c=c.nodeNext)if(c.nodeIdleTime<b)return!0;return!1};cH.prototype.processComponents=function(a){var b=this.idleSpeedThreshold,d=b?b*b:S(this.gravity)*a*a,e=this.bodies;for(var f=0;f<e.length;f++){var g=e[f],h=d?g.m*d:0;g.nodeIdleTime=g.kineticEnergy()>h?0:g.nodeIdleTime+a,c(g.nodeNext===null,"Internal Error: Dangling next pointer detected in contact graph."),c(g.nodeRoot===null,"Internal Error: Dangling root pointer detected in contact graph.")}var i=this.arbiters;for(var f=0,j=i.length;f<j;f++){var k=i[f],l=k.body_a,m=k.body_b;(m.isRogue()&&!m.isStatic()||l.isSleeping())&&l.activate(),(l.isRogue()&&!l.isStatic()||m.isSleeping())&&m.activate(),l.pushArbiter(k),m.pushArbiter(k)}var n=this.constraints;for(var f=0;f<n.length;f++){var o=n[f],l=o.a,m=o.b;m.isRogue()&&!m.isStatic()&&l.activate(),l.isRogue()&&!l.isStatic()&&m.activate()}for(var f=0;f<e.length;){var g=e[f];if(cJ(g)===null){cM(g,g);if(!cN(g,this.sleepTimeThreshold)){this.sleepingComponents.push(g);for(var p=g;p;p=p.nodeNext)this.deactivateBody(p);continue}}f++,g.nodeRoot=null,g.nodeNext=null}},bJ.prototype.sleep=function(){this.sleepWithGroup(null)},bJ.prototype.sleepWithGroup=function(a){b(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var c=this.space;b(c,"Cannot put a rogue body to sleep."),b(!c.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),b(a===null||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier.");if(this.isSleeping()){b(cJ(this)===cJ(a),"The body is already sleeping and it's group cannot be reassigned.");return}for(var d=0;d<body.shapeList.length;d++)body.shapeList.update(this.p,this.rot);c.deactivateBody(this);if(a){var e=cJ(a);this.nodeRoot=e,this.nodeNext=e.nodeNext,this.nodeIdleTime=0,e.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,c.sleepingComponents.push(this);k(c.bodies,this)},cH.prototype.activateShapesTouchingShape=function(a){this.sleepTimeThreshold!==Infinity&&this.shapeQuery(a,function(a,b){a.body.activate()})},cH.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)};this.lock(),this.activeShapes.pointQuery(a,e),this.staticShapes.pointQuery(a,e),this.unlock(!0)},cH.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},cH.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},cH.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&g.t<e.t&&(e=g),e.t};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e.t,f),e},cH.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&bi(a,e.bb_l,e.bb_b,e.bb_r,e.bb_t)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},cH.prototype.shapeQuery=function(a,b){var c=a.body;c&&a.update(c.p,c.rot);var d=new bf(a.bb_l,a.bb_b,a.bb_r,a.bb_t),e=!1,f=function(c){var d=a;if(d.group&&d.group===c.group||!(d.layers&c.layers)||d===c)return;var f;if(d.collisionCode<=c.collisionCode)f=cpCollideShapes(d,c);else{f=cpCollideShapes(c,d);for(var g=0;g<f.length;g++)f[g].n=J(f[g].n)}if(f.length){e=!d.sensor&&!c.sensor;if(b){var h=new Array(f.length);for(var g=0;g<f.length;g++)h[g]=new co(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},cH.prototype.addPostStepCallback=function(a){assertWarn(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},cH.prototype.runPostStepCallbacks=function(){for(var a=0;a<this.postStepCallbacks.length;a++)this.postStepCallbacks[a]()},cH.prototype.lock=function(){this.locked++},cH.prototype.unlock=function(a){this.locked--,b(this.locked>=0,"Internal Error: Space lock underflow.");if(!this.locked&&a){var c=this.rousedBodies;for(var d=0;d<c.length;d++)this.activateBody(c[d]);c.length=0,this.runPostStepCallbacks()}},cH.prototype.makeCollideShapes=function(){var a=this;return function(b,c){var e=a;if(!(b.bb_l<=c.bb_r&&c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t)||b.body===c.body||b.group&&b.group===c.group||!(b.layers&c.layers))return;var f=e.lookupHandler(b.collision_type,c.collision_type),g=b.sensor||c.sensor;if(g&&f===cG)return;if(b.collisionCode>c.collisionCode){var h=b;b=c,c=h}var i=cF(b,c);if(i.length===0)return;var j=d(b.hashid,c.hashid),k=e.cachedArbiters[j];k||(k=e.cachedArbiters[j]=new cn(b,c)),k.update(i,f,b,c),k.state=="first coll"&&!f.begin(k,e)&&k.ignore(),k.state!=="ignore"&&f.preSolve(k,e)&&!g?e.arbiters.push(k):(k.contacts=null,k.state!=="ignore"&&(k.state="normal")),k.stamp=e.stamp}},cH.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&a.state!="cached"&&(a.callSeparate(this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var cO=function(a){var b=a.body;a.update(b.p,b.rot)};cH.prototype.step=function(a){if(a===0)return;b(C.x===0&&C.y===0,"vzero is invalid"),this.stamp++;var c=this.curr_dt;this.curr_dt=a;var d=this.bodies,e=this.constraints,f=this.arbiters;for(var g=0;g<f.length;g++){var h=f[g];h.state="normal",!h.body_a.isSleeping()&&!h.body_b.isSleeping()&&h.unthread()}f.length=0,this.lock();for(var g=0;g<d.length;g++){var i=d[g];i.position_func(a)}this.activeShapes.each(cO),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),(this.sleepTimeThreshold!=Infinity||this.enableContactGraph)&&this.processComponents(a),this.lock();for(var j in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[j])||delete this.cachedArbiters[j];var k=this.collisionSlop,l=1-Math.pow(this.collisionBias,a);for(var g=0;g<f.length;g++)f[g].preStep(a,k,l);for(var g=0;g<e.length;g++){var m=e[g];m.preSolve(this),m.preStep(a)}var n=Math.pow(this.damping,a),o=this.gravity;for(var g=0;g<d.length;g++){var i=d[g];i.velocity_func(o,n,a)}var p=c===0?0:a/c;for(var g=0;g<f.length;g++)f[g].applyCachedImpulse(p);for(var g=0;g<e.length;g++){var m=e[g];m.applyCachedImpulse(p)}for(var g=0;g<this.iterations;g++){for(var q=0;q<f.length;q++)f[q].applyImpulse();for(var q=0;q<e.length;q++)e[q].applyImpulse()}for(var g=0;g<e.length;g++)e[g].postSolve(this);for(var g=0;g<f.length;g++){var h=f[g];h.handler.postSolve(h,this)}this.unlock(!0)};var cP=function(a,b,c,d){var e=a.vx+ -c.y*a.w,f=a.vy+c.x*a.w,g=b.vx+ -d.y*b.w,h=b.vy+d.x*b.w;return new B(g-e,h-f)},cQ=function(a,b,c,d,e){var f=a.vx+ -c.y*a.w,g=a.vy+c.x*a.w,h=b.vx+ -d.y*b.w,i=b.vy+d.x*b.w;return E(h-f,i-g,e.x,e.y)},cR=function(a,b,c,d){a.vx+=b*a.m_inv,a.vy+=c*a.m_inv,a.w+=a.i_inv*(d.x*c-d.y*b)},cS=function(a,b,c,d,e,f){cR(a,-e,-f,c),cR(b,e,f,d)},cT=function(a,b,c,d){a.v_biasx+=b*a.m_inv,a.v_biasy+=c*a.m_inv,a.w_bias+=a.i_inv*M(d.x,d.y,b,c)},cU=function(a,b,c){var d=L(b,c);return a.m_inv+a.i_inv*d*d},cV=function(a,b,d,e,f){var g=cU(a,d,f)+cU(b,e,f);return c(g!==0,"Unsolvable collision or constraint."),g},cW=function(a,b,d,e){var f,g,h,i,j=a.m_inv+b.m_inv;f=j,g=0,h=0,i=j;var k=a.i_inv,l=d.x*d.x*k,m=d.y*d.y*k,n=-d.x*d.y*k;f+=m,g+=n,h+=n,i+=l;var o=b.i_inv,p=e.x*e.x*o,q=e.y*e.y*o,r=-e.x*e.y*o;f+=q,g+=r,h+=r,i+=p;var s=f*i-g*h;c(s!==0,"Unsolvable constraint.");var t=1/s;return[new B(i*t,-g*t),new B(-h*t,f*t)]},cX=function(a,b,c){return new B(D(a,b),D(a,c))},cY=function(a,b){return 1-Math.pow(a,b)},cZ=a.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=Infinity,this.errorBias=fpow(.9,60),this.maxBias=Infinity};cZ.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},cZ.prototype.preStep=function(a){},cZ.prototype.applyCachedImpulse=function(a){},cZ.prototype.applyImpulse=function(){},cZ.prototype.getImpulse=function(){return 0},cZ.prototype.preSolve=function(a){},cZ.prototype.postSolve=function(a){}})()