/* Copyright (c) 2007 Scott Lembcke
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};var assert=function(a,b){if(!a)throw new Error("Assertion failed: "+b)},assertSoft=function(a,b){!a&&console&&console.warn&&console.warn("ASSERTION FAILED: "+b)},hashPair=function(a,b){return a+" "+b},Contact=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=vzero,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d},deleteObjFromList=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b){a[c]=a[a.length-1],a.length--;return}},momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+vlengthsq(d))},areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},momentForSegment=function(a,b,c){var d=vlength(vsub(c,b)),e=vmult(vadd(b,c),.5);return a*(d*d/12+vlengthsq(e))},areaForSegment=function(a,b,c){return c*(Math.PI*c+2*vdist(a,b))},momentForPoly=function(a,b,c){var d=0,e=0;for(var f=0,g=b.length;f<g;f++){var h=vadd(b[f],c),i=vadd(b[(f+1)%g],c),j=vcross(i,h),k=vdot(h,h)+vdot(h,i)+vdot(i,i);d+=j*k,e+=j}return a*d/(6*e)},areaForPoly=function(a){var b=0;for(var c=0,d=a.length;c<d;c++)b+=vcross(a[c],a[(c+1)%d]);return-b/2},centroidForPoly=function(a){var b=0,c=[0,0];for(var d=0,e=a.length;d<e;d++){var f=a[d],g=a[(d+1)%e],h=vcross(f,g);b+=h,c=vadd(c,vmult(vadd(f,g),h))}return vmult(c,1/(3*b))},recenterPoly=function(a){var b=centroidForPoly(a);for(var c=0;c<a.length;c++)a[c]=vsub(a[c],b)},momentForBox=function(a,b,c){return a*(b*b+c*c)/12},momentForBox2=function(a,b){return width=b.r-b.l,height=b.t-b.b,offset=vmult([b.l+b.r,b.b+b.t],.5),momentForBox(a,width,height)+a*vlengthsq(offset)},clamp=function(a,b,c){return Math.min(Math.max(a,b),c)},clamp01=function(a){return Math.max(0,Math.min(a,1))},lerp=function(a,b,c){return a*(1-c)+b*c},lerpconst=function(a,b,c){return a+clamp(b-a,-c,c)},Vect=exports.Vect=function(a,b){this.x=a,this.y=b},vzero=new Vect(0,0),vdot=function(a,b){return a.x*b.x+a.y*b.y},vlength=function(a){return Math.sqrt(vdot(a,a))},veql=function(a,b){return a.x===b.x&&a.y===b.y},vadd=function(a,b){return new Vect(a.x+b.x,a.y+b.y)};Vect.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var vsub=function(a,b){return new Vect(a.x-b.x,a.y-b.y)};Vect.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var vneg=function(a){return new Vect(-a.x,-a.y)};Vect.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var vmult=function(a,b){return new Vect(a.x*b,a.y*b)};Vect.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var vcross=function(a,b){return a.x*b.y-a.y*b.x},vperp=function(a){return new Vect(-a.y,a.x)},vpvrperp=function(a){return new Vect(a.y,-a.x)},vproject=function(a,b){return vmult(b,vdot(a,b)/b.lengthsq())};Vect.prototype.project=function(a){return this.mult(vdot(this,a)/a.lengthsq()),this};var vrotate=function(a,b){return new Vect(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};Vect.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this};var vunrotate=function(a,b){return new Vect(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},vlengthsq=function(a){return vdot(a,a)},vlerp=function(a,b,c){return vadd(vmult(a,1-c),vmult(b,c))},vnormalize=function(a){return vmult(a,1/vlength(a))},vnormalize_safe=function(a){return a.x===0&&a.y===0?vzero:vnormalize(a)},vclamp=function(a,b){return vdot(a,a)>b*b?vmult(vnormalize(a),b):a},vlerpconst=function(a,b,c){return vadd(a,vclamp(vsub(b,a),c))},vdist=function(a,b){return vlength(vsub(a,b))},vdistsq=function(a,b){return vlengthsq(vsub(a,b))},vnear=function(a,b,c){return vdistsq(a,b)<c*c},vslerp=function(a,b,c){var d=Math.acos(vdot(a,b));if(d){var e=1/Math.sin(d);return vadd(vmult(a,Math.sin((1-c)*d)*e),vmult(b,Math.sin(c*d)*e))}return a},vslerpconst=function(a,b,c){var d=Math.acos(vdot(a,b));return vslerp(a,b,Math.min(c,d)/d)},vforangle=function(a){return new Vect(Math.cos(a),Math.sin(a))},vtoangle=function(a){return Math.atan2(a.y,a.x)},vstr=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"},BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d},bbNewForCircle=function(a,b){return new BB(a.x-b,a.y-b,a.x+b,a.y+b)},bbIntersects=function(a,b){return a.l<=b.r&&b.l<=a.r&&a.b<=b.t&&b.b<=a.t},bbContainsBB=function(a,b){return a.l<=b.l&&a.r>=b.r&&a.b<=b.b&&a.t>=b.t},bbContainsVect=function(a,b){return a.l<=b.x&&a.r>=b.x&&a.b<=b.y&&a.t>=b.y},bbMerge=function(a,b){return new BB(Math.min(a.l,b.l),Math.min(a.b,b.b),Math.max(a.r,b.r),Math.max(a.t,b.t))},bbExpand=function(a,b){return new BB(Math.min(a.l,b.x),Math.min(a.b,b.y),Math.max(a.r,b.x),Math.max(a.t,b.y))},bbArea=function(a){return(a.r-a.l)*(a.t-a.b)},bbMergedArea=function(a,b){return(Math.max(a.r,b.r)-Math.min(a.l,b.l))*(Math.max(a.t,b.t)-Math.min(a.b,b.b))},bbSegmentQuery=function(a,b,c){var d=1/(c.x-b.x),e=a.l==b.x?-Infinity:(a.l-b.x)*d,f=a.r==b.x?Infinity:(a.r-b.x)*d,g=Math.min(e,f),h=Math.max(e,f),i=1/(c.y-b.y),j=a.b==b.y?-Infinity:(a.b-b.y)*i,k=a.t==b.y?Infinity:(a.t-b.y)*i,l=Math.min(j,k),m=Math.max(j,k);if(l<=h&&g<=m){var n=Math.max(g,l),o=Math.min(h,m);if(0<=o&&n<=1)return Math.max(n,0)}return Infinity},bbIntersectsSegment=function(a,b,c){return bbSegmentQuery(a,b,c)!=Infinity},bbClampVect=function(a,b){var c=Math.min(Math.max(a.l,b.x),a.r),d=Math.min(Math.max(a.b,b.y),a.t);return new Vect(c,d)},bbWrapVect=function(a,b){var c=Math.abs(a.r-a.l),d=(b.x-a.l)%c,e=d>0?d:d+c,f=Math.abs(a.t-a.b),g=(b.y-a.b)%f,h=g>0?g:g+f;return new Vect(e+a.l,h+a.b)},shapeIDCounter=0,CP_NO_GROUP=0,CP_ALL_LAYERS=-1;exports.resetShapeIdCounter=function(){shapeIDCounter=0};var Shape=exports.Shape=function(a){this.body=a,this.bb=null,this.hashid=shapeIDCounter++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=vzero,this.collision_type=0,this.group=0,this.layers=CP_ALL_LAYERS,this.space=null,this.collisionCode=this.collisionCode};Shape.prototype.active=function(){return this.prev||this.body.shapeList.length>0&&this.body.shapeList[0]===this},Shape.prototype.setBody=function(a){assert(!this.active(),"You cannot change the body on an active shape. You must remove the shape, then "),this.body=a},Shape.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},Shape.prototype.update=function(a,b){return this.bb=this.cacheData(a,b)};var PointQueryExtendedInfo=function(a){this.shape=a,this.d=Infinity,this.n=vzero},SegmentQueryInfo=function(a,b,c){this.shape=a,this.t=b,this.n=c},CircleShape=exports.CircleShape=function(a,b,c){this.c=c,this.r=b,this.type="circle",Shape.apply(this,a)};CircleShape.prototype=Object.create(Shape.prototype),CircleShape.prototype.cacheData=function(a,b){var c=this.tc=vadd(a,vrotate(this.c,b));return bbNewForCircle(c,this.r)},CircleShape.prototype.pointQuery=function(a){var b=vsub(a,this.tc),c=vlengthsq(b),d=this.r;if(c<d*d){var e=new PointQueryExtendedInfo(this),f=fsqrt(c);return e.d=d-f,e.n=vmult(b,1/f),e}};var circleSegmentQuery=function(a,b,c,d,e,f){d=vsub(d,b),e=vsub(e,b);var g=vdot(d,d)-2*vdot(d,e)+vdot(e,e),h=-2*vdot(d,d)+2*vdot(d,e),i=vdot(d,d)-c*c,j=h*h-4*g*i;if(j>=0){var k=(-h-Math.sqrt(j))/(2*g);if(0<=k&&k<=1)return new SegmentQueryInfo(a,k,vnormalize(vlerp(d,e,k)))}};CircleShape.prototype.segmentQuery=function(a,b){return circleSegmentQuery(this,this.tc,this.r,a,b)};var SegmentShape=exports.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=vperp(vnormalize(vsub(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=vzero,this.b_tangent=vzero,this.type="segment",Shape.apply(this,a)};SegmentShape.prototype=Object.create(Shape.prototype),SegmentShape.prototype.cacheData=function(a,b){this.ta=vadd(a,vrotate(this.a,b)),this.tb=vadd(a,vrotate(this.b,b)),this.tn=vrotate(this.n,b);var c,d,e,f;this.ta[0]<this.tb[0]?(c=this.ta[0],d=this.tb[0]):(c=this.tb[0],d=this.ta[0]),this.ta[1]<this.tb[1]?(e=this.ta[1],f=this.tb[1]):(e=this.tb[1],f=this.ta[1]);var g=this.r;return new BB(c-g,e-g,d+g,f+g)},SegmentShape.prototype.pointQuery=function(a){if(!bbContainsVect(this.bb,a))return;var b=this.ta,c=this.tb,d=vsub(c,b),e=fclamp01(vdot(d,vsub(a,b))/vlengthsq(d)),f=vadd(b,vmult(d,e)),g=vsub(a,f),h=vlengthsq(g),i=this.r;if(h<i*i){var j=new PointQueryExtendedInfo(this),k=Math.sqrt(h);return j.d=i-k,j.n=vmult(g,1/k),j}},SegmentShape.prototype.segmentQuery=function(a,b){var c=this.tn,d=vdot(vsub(this.ta,a),c),e=this.r,f=d>0?vneg(c):c,g=vsub(vmult(f,e),a),h=vadd(this.ta,g),i=vadd(this.tb,g),j=vsub(b,a);if(vcross(j,h)*vcross(j,i)<=0){var k=d+(d>0?-e:e),l=-k,m=vdot(j,c)-k;if(l*m<0)return{shape:this,t:l/(l-m),n:f}}else if(e!=0){var n=circleSegmentQuery(this,this.ta,this.r,a,b),o=circleSegmentQuery(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},SegmentShape.prototype.setNeighbors=function(a,b){this.a_tangent=vsub(a,this.a),this.b_tangent=vsub(b,this.b)},SegmentShape.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=vperp(vnormalize(vsub(b,a)))},exports.segmentQueryHitPoint=function(a,b,c){return vlerp(a,b,c.t)},exports.segmentQueryHitDist=function(a,b,c){return vdist(a,b)*c.t};var polyValidate=function(a){var b=a.length;for(var c=0;c<b;c++){var d=a[c],e=a[(c+1)%b],f=a[(c+2)%b];if(vcross(vsub(e,d),vsub(f,e))>0)return!1}return!0},PolyShape=exports.PolyShape=function(a,b,c){assert(polyValidate(b),"Polygon is concave or has a reversed winding."),this.setVerts(b,c),this.type="poly",Shape.apply(this,a)};PolyShape.prototype=Object.create(Shape.prototype);var Axis=function(a,b){this.n=a,this.d=b};PolyShape.prototype.setVerts=function(a,b){var c=a.length;this.verts=new Array(c),this.tVerts=new Array(c),this.axes=new Array(c),this.tAxes=new Array(c);for(var d=0;d<c;d++){var e=vadd(b,a[d]),f=vadd(b,a[(d+1)%c]),g=vnormalize(vperp(vsub(f,e)));this.verts[d]=e,this.axes[d]=new Axis(g,vdot(g,e)),this.tAxes[d]=new Axis(vzero,0)}};var BoxShape=exports.BoxShape=function(a,b,c){var d=b/2,e=c/2;return BoxShape2(a,new BB(-d,-e,d,e))},BoxShape2=exports.BoxShape2=function(a,b){var c=[new Vert(b.l,b.b),new Vert(b.l,b.t),new Vert(b.r,b.t),new Vert(b.r,b.b)];return new PolyShape(a,c,vzero)};PolyShape.prototype.transformVerts=function(a,b){var c=this.verts,d=this.tVerts,e=Infinity,f=-Infinity,g=Infinity,h=-Infinity;for(var i=0;i<c.length;i++){var j=vadd(a,vrotate(c[i],b));d[i]=j,e=Math.min(e,j.x),f=Math.max(f,j.x),g=Math.min(g,j.y),h=Math.max(h,j.y)}return this.bb=new BB(e,g,f,h)},PolyShape.prototype.transformAxes=function(a,b){var c=this.axes,d=this.tAxes;for(var e=0;e<c.length;e++){var f=vrotate(c[e].n,b);d[e].n=f,d[e].d=vdot(a,f)+c[e].d}},PolyShape.prototype.cacheData=function(a,b){return this.transformAxes(a,b),this.transformVerts(a,b)},PolyShape.prototype.pointQuery=function(a){if(!bbContainsVect(this.shape.bb,a))return;var b=new PointQueryExtendedInfo(this),c=this.tAxes;for(var d=0;d<c.length;d++){var e=c[d].n,f=c[d].d-vdot(e,a);if(f<0)return;f<b.d&&(b.d=f,b.n=e)}return b},PolyShape.prototype.segmentQuery=function(a,b){var c=this.tAxes,d=this.tVerts,e=this.verts.length;for(var f=0;f<e;f++){var g=c[f].n,h=vdot(a,g);if(c[f].d>h)continue;var i=vdot(b,g),j=(c[f].d-h)/(i-h);if(j<0||1<j)continue;var k=vlerp(a,b,j),l=-vcross(g,k),m=-vcross(g,d[f]),n=-vcross(g,d[(f+1)%e]);if(m<=l&&l<=n)return new SegmentQueryInfo(this,j,g)}},PolyShape.prototype.getVert=function(a){return this.verts[a]},PolyShape.prototype.valueOnAxis=function(a,b){var c=this.tVerts,d=vdot(a,c[0]);for(var e=1;e<c.length;e++)d=Math.min(d,vdot(a,c[e]));return d-b},PolyShape.prototype.containsVert=function(a){var b=this.tAxes;for(var c=0;c<b.length;c++){var d=vdot(b[c].n,a)-b[c].d;if(d>0)return!1}return!0},PolyShape.prototype.containsVertPartial=function(a,b){var c=this.tAxes;for(var d=0;d<c.length;d++){if(vdot(c[d].n,b)<0)continue;var e=vdot(c[d].n,a)-c[d].d;if(e>0)return!1}return!0};var Body=function(a,b){Body.prototype.velocity_func=Body.prototype.updateVelocity,Body.prototype.position_func=Body.prototype.updatePosition,this.p=vzero,this.v=vzero,this.f=vzero,this.w=0,this.t=0,this.v_limit=Infinity,this.wlimit=Infinity,this.v_bias=vzero,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.setAngle(0)},createStaticBody=function(){return body=new Body(Infinity,Infinity),body.nodeIdleTime=Infinity,body};if(typeof DEBUG!="undefined"&&DEBUG){var v_assert_nan=function(a,b){assert(a.x==a.x&&a.y==a.y,b)},v_assert_infinite=function(a,b){assert(Math.abs(a.x)!==Infinity&&Math.abs(a.y)!==Infinity,b)},v_assert_sane=function(a,b){v_assert_nan(a,b),v_assert_infinite(a,b)};Body.prototype.sanityCheck=function(){assert(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),assert(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),v_assert_sane(this.p,"Body's position is invalid."),v_assert_sane(this.v,"Body's velocity is invalid."),v_assert_sane(this.f,"Body's force is invalid."),assert(this.a===this.a&&Math.abs(this.a)!==Infinity,"Body's angle is invalid."),assert(this.w===this.w&&Math.abs(this.w)!==Infinity,"Body's angular velocity is invalid."),assert(this.t===this.t&&Math.abs(this.t)!==Infinity,"Body's torque is invalid."),v_assert_sane(this.rot,"Internal error: Body's rotation vector is invalid."),assert(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),assert(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else Body.prototype.sanityCheck=function(){};Body.prototype.isSleeping=function(){return body.nodeRoot!==null},Body.prototype.isStatic=function(){return body.nodeIdleTime===Infinity},Body.prototype.isRogue=function(){return body.space===null},Body.prototype.setMass=function(a){assert(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},Body.prototype.setMoment=function(a){assert(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},Body.prototype.addShape=function(a){this.shapeList.push(a)},Body.prototype.removeShape=function(a){deleteObjFromList(this.shapeList,a)};var filterConstraints=function(a,b,c){return a==c?a.next(b):(a.a===b?a.next_a=filterConstraints(a.next_a,b,c):a.next_b=filterConstraints(a.next_b,b,c),a)};Body.prototype.removeConstraint=function(a){this.constraintList=filterConstraints(this.constraintList,this,a)},Body.prototype.setPos=function(a){this.activate(),this.sanityCheck(),this.p=a},Body.prototype.setAngleInternal=function(a){this.a=a,this.rot=vforangle(a)},Body.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},Body.prototype.updateVelocity=function(a,b,c){this.v=vclamp(vadd(vmult(this.v,b),vmult(vadd(a,vmult(this.f,this.m_inv)),c)),this.v_limit);var d=this.w_limit;this.w=clamp(this.w*b+this.t*this.i_inv*c,-d,d),this.sanityCheck()},Body.prototype.updatePosition=function(a){this.p=vadd(this.p,vmult(vadd(this.v,this.v_bias),a)),this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_bias=vzero,this.w_bias=0,this.sanityCheck()},Body.prototype.resetForces=function(){this.activate(),this.f=vzero,this.t=0},Body.prototype.applyForce=function(a,b){this.activate(),this.f=vadd(this.f,a),this.t+=vcross(b,a)},Body.prototype.applyImpulse=function(a,b){this.activate(),apply_impulse(this,a,b)},Body.prototype.getVelAtPoint=function(a){return vadd(this.v,vmult(vperp(a),body.w))},Body.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(vsub(a,body.p))},Body.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(vrotate(a,body.rot))},Body.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;b<c;b++)a(this.shapeList[b])},Body.prototype.eachConstraint=function(a){var b=this.constraintList;while(b){var c=b.next(body);a(b),b=c}},Body.prototype.eachArbiter=function(a){var b=this.arbiterList;while(b){var c=b.next(body);b.swappedColl=this===b.body_b,a(b),b=c}},Body.prototype.local2World=function(a){return vadd(this.p,vrotate(a,this.rot))},Body.prototype.world2Local=function(a){return vunrotate(vsub(a,this.p),this.rot)},Body.prototype.kineticEnergy=function(){var a=vdot(this.v,this.v),b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var SpatialIndex=exports.SpatialIndex=function(a,b){this.bbfunc=a,this.staticIndex=b,b&&(assert(!b.dynamicIndex,"This static index is already associated with a dynamic index."),b.dynamicIndex=this)};SpatialIndex.prototype.collideStatic=function(a,b){if(a.count()>0){var c=this.bbfunc,d=a.query;this.each(function(a){d(a,c(a),b)})}};var BBTree=exports.BBTree=function(a,b){SpatialIndex.call(this,a,b),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.stamp=0};BBTree.prototype=Object.create(SpatialIndex.prototype);var Node=function(a,b,c){this.obj=null,this.bb=bbMerge(b.bb,c.bb),this.parent=null,this.setA(b),this.setB(c)},Leaf=function(a,b){this.obj=b,this.bb=a.getBB(b),this.parent=null,this.stamp=1,this.pairs=null};BBTree.prototype.getBB=function(a){var b=this.bbfunc(a),c=this.velocityFunc;if(c){var d=.1,e=(b.r-b.l)*d,f=(b.t-b.b)*d,g=vmult(c(a),.1);return bbNew(b.l+Math.min(-e,g.x),b.b+Math.min(-f,g.y),b.r+Math.max(e,g.x),b.t+Math.max(f,g.y))}return b},BBTree.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},BBTree.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var Pair=function(a,b){this.a=a,this.b=b},Thread=function(a,b){this.prev=null,this.next=b,this.leaf=a};Thread.prototype.unlink=function(){var a=this.next,b=this.prev;a&&(a.a.leaf==this.leaf?a.a.prev=b:a.b.prev=b),b?b.a.leaf==this.leaf?b.a.next=a:b.b.next=a:this.leaf.pairs=a},Leaf.prototype.clearPairs=function(a){var b=leaf.pairs,c;this.pairs=null;while(b)b.a.leaf==this?(c=b.a.next,b.b.unlink(),b=c):(c=b.b.next,b.a.unlink(),b=c)};var pairInsert=function(a,b,c){var d=a.pairs,e=b.pairs,f=new Pair(new Thread(a,d),new Thread(b,e));a.pairs=b.pairs=f,d&&(d.a.leaf==a?d.a.prev=f:d.b.prev=f),e&&(e.a.leaf==b?e.a.prev=f:e.b.prev=f)};Node.prototype.setA=function(a){this.A=a,a.parent=node},Node.prototype.setB=function(a){this.B=a,a.parent=node},Leaf.prototype.isLeaf=!0,Node.prototype.isLeaf=!1,Node.prototype.otherChild=function(a){return this.A==a?this.B:this.A},Node.prototype.replaceChild=function(a,b,c){assertSoft(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?this.setA(b):this.setB(b);for(var d=parent;d;d=d.parent)d.bb=bbMerge(d.A.bb,d.B.bb)};var bbProximity=function(a,b){return fabs(a.l+a.r-b.l-b.r)+fabs(a.b+b.t-b.b-b.t)},subtreeInsert=function(a,b,c){if(a==null)return b;if(a.isLeaf)return new Node(c,b,a);var d=bbArea(a.B.bb)+bbMergedArea(a.A.bb,b.bb),e=bbArea(a.A.bb)+bbMergedArea(a.B.bb,b.bb);return d===e&&(d=bbProximity(a.A.bb,b.bb),e=bbProximity(a.B.bb,b.bb)),e<d?a.setB(subtreeInsert(a.B,b,c)):a.setA(subtreeInsert(a.A,b,c)),a.bb=bbMerge(a.bb,b.bb),a},subtreeQuery=function(a,b,c){bbIntersects(a.bb,b)&&(a.isLeaf?c(a.obj):(subtreeQuery(a.A,b,c),subtreeQuery(a.B,b,c)))},subtreeSegmentQuery=function(a,b,c,d,e){if(a.isLeaf)return e(a.obj);var f=bbSegmentQuery(a.A.bb,b,c),g=bbSegmentQuery(a.B.bb,b,c);return f<g?(f<d&&(d=Math.min(d,subtreeSegmentQuery(a.A,b,c,d,e,data))),g<d&&(d=Math.min(d,subtreeSegmentQuery(a.B,b,c,d,e,data)))):(g<d&&(d=Math.min(d,subtreeSegmentQuery(a.B,b,c,d,e,data))),f<d&&(d=Math.min(d,subtreeSegmentQuery(a.A,b,c,d,e,data)))),d},subtreeRemove=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,e}return d.parent.replaceChild(d,d.otherChild(b),c),a},markLeafQuery=function(a,b,c,d,e){bbIntersects(b.bb,a.bb)&&(a.isLeaf?c?pairInsert(b,a,d):(a.stamp<b.stamp&&pairInsert(a,b,d),e&&e(b.obj,a.obj)):(markLeafQuery(a.A,b,c,d,e),markLeafQuery(a.B,b,c,d,e)))},markLeaf=function(a,b,c,d){if(a.stamp==b.getStamp()){c&&markLeafQuery(c,a,!1,context);for(var e=a;e.parent;e=e.parent)e==e.parent.A?markLeafQuery(e.parent.B,a,!0,b,d):markLeafQuery(e.parent.A,a,!1,b,d)}else{var f=a.pairs;while(f)a==f.b.leaf?(d&&d(f.a.leaf.obj,a.obj),f=f.b.next):f=f.a.next}},markSubtree=function(a,b,c,d){a.isLeaf?markLeaf(a,b,c,d):(markSubtree(a.A,b,c,d),markSubtree(a.B,b,c,d))};Leaf.prototype.update=function(a){var b=a.root,c=a.bbfunc(this.obj);return bbContainsBB(this.bb,c)?!1:(this.bb=a.getBB(this.obj),b=subtreeRemove(b,this,a),a.root=subtreeInsert(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},Leaf.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&markLeafQuery(c,this,!0,b,null)}else{var d=a.staticIndex.root;markLeaf(this,a,d,null)}},BBTree.prototype.insert=function(a,b){var c=new Leaf(this,a);this.leaves[b]=c,this.root=subtreeInsert(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},BBTree.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=subtreeRemove(this.root,c,this),this.count--,c.clearPairs(this)},BBTree.prototype.contains=function(a,b){return this.leaves[b]!=null};var voidQueryFunc=function(a,b){};BBTree.prototype.reindexQuery=function(a){if(!this.root)return;var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;markSubtree(this.root,this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()},BBTree.prototype.reindex=function(){this.reindexQuery(voidQueryFunc)},BBTree.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},BBTree.prototype.pointQuery=function(a,b){this.root&&subtreeQuery(this.root,new BB(a.x,a.y,a.x,a.y),b)},BBTree.prototype.segmentQuery=function(a,b,c,d){this.root&&subtreeSegmentQuery(this,a,b,c,d)},BBTree.prototype.query=function(a,b){this.root&&subtreeQuery(this.root,a,b)},BBTree.prototype.count=function(){return this.count},BBTree.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b])};var partitionNodes=function(a,b,c,d){if(d==1)return b[c];if(d==2)return new Node(a,b[c],b[c+1]);var e=b[c].bb,f=c+d;for(var g=c+1;g<f;g++)e=bbMerge(e,b[g].bb);var h=e.r-e.l>e.t-e.b,i=new Array(d*2);if(h)for(var g=c;g<f;g++)i[2*g+0]=b[g].bb.l,i[2*g+1]=b[g].bb.r;else for(var g=c;g<f;g++)i[2*g+0]=b[g].bb.b,i[2*g+1]=b[g].bb.t;i.sort(function(a,b){return a-b});var j=(i[d-1]+i[d])*.5,k=e,l=e;h?k.r=l.l=j:k.t=l.b=j;var m=f;for(var n=c;n<m;){var o=b[n];bbMergedArea(o.bb,l)<bbMergedArea(o.bb,k)?(m--,b[n]=b[m],b[m]=o):n++}if(m==d){var o=null;for(var g=c;g<f;g++)o=subtreeInsert(o,b[g],a);return o}return NodeNew(a,partitionNodes(a,b,c,m-c),partitionNodes(a,b,m,f-m))};BBTree.prototype.optimize=function(){var a=new Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];this.root=partitionNodes(tree,a,a.length)};var CollisionHandler=exports.CollisionHandler=function(){this.a=this.b=0};CollisionHandler.prototype.begin=function(a,b){return!0},CollisionHandler.prototype.preSolve=function(a,b){return!0},CollisionHandler.prototype.postSolve=function(a,b){},CollisionHandler.prototype.separate=function(a,b){};var CP_MAX_CONTACTS_PER_ARBITER=4,Arbiter=function(a,b){this.e=0,this.u=0,this.surface_vr=vzero,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};Arbiter.prototype.totalImpulse=function(){var a=this.contacts,b=vzero;for(var c=0,d=a.length;c<d;c++){var e=a[c];b=vadd(b,vmult(e.n,e.jnAcc))}return this.swappedColl?b:vneg(b)},Arbiter.prototype.totalImpulseWithFriction=function(){var a=this.contacts,b=vzero;for(var c=0,d=a.length;c<d;c++){var e=a[c];b=vadd(b,vrotate(e.n,new Vect(e.jnAcc,e.jtAcc)))}return this.swappedColl?b:vneg(b)},Arbiter.prototype.totalKE=function(){var a=(1-arb.e)/(1+arb.e),b=0,c=arb.contacts;for(var d=0,e=c.length;d<e;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},Arbiter.prototype.ignore=function(){this.state="ignore"},Arbiter.prototype.getA=function(){return this.swappedColl?this.b:this.a},Arbiter.prototype.getB=function(){return this.swappedColl?this.a:this.b},Arbiter.prototype.isFirstContact=function(){return this.state==="first coll"};var ContactPoint=function(a,b,c){this.point=a,this.normal=b,this.dist=c};Arbiter.prototype.getContactPointSet=function(){var a=new Array(this.contacts.length),b;for(b=0;b<a.length;b++)a[b]=new ContactPoint(this.contacts[b].p,this.contacts[b].n,this.contacts[b].dist);return a},Arbiter.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?vneg(b):b},Arbiter.prototype.getPoint=function(a){return this.contacts[a].p},Arbiter.prototype.getDepth=function(a){return this.contacts[a].dist};var unthreadHelper=function(a,b,c,d){c?(c.body_a===b?c.thread_a_next:c.thread_b_next).next=d:b.arbiterList=d,d&&((d.body_a===b?d.thread_a_prev:d.thread_b_prev).prev=c)};Arbiter.prototype.unthread=function(){unthreadHelper(this,this.body_a,this.thread_a_prev,this.thread_a_next),unthreadHelper(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},Arbiter.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;e<this.contacts.length;e++){var f=this.contacts[e];for(var g=0;g<a.length;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=vsub(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,this.state=="cached"&&(this.state="first coll")},Arbiter.prototype.preStep=function(a,b,c){var d=this.body_a,e=this.body_b;for(var f=0;f<this.contacts.length;f++){var g=this.contacts[f];g.r1=vsub(g.p,d.p),g.r2=vsub(g.p,e.p),g.nMass=1/k_scalar(d,e,g.r1,g.r2,g.n),g.tMass=1/k_scalar(d,e,g.r1,g.r2,vperp(g.n)),g.bias=-c*Math.min(0,g.dist+b)/a,g.jBias=0,g.bounce=normal_relative_velocity(d,e,g.r1,g.r2,g.n)*this.e}},Arbiter.prototype.applyCachedImpulse=function(a){if(this.isFirstContact())return;var b=this.body_a,c=this.body_b;for(var d=0;d<this.contacts.length;d++){var e=this.contacts[d],f=vrotate(e.n,new Vect(e.jnAcc,e.jtAcc));apply_impulses(b,c,e.r1,e.r2,vmult(f,a))}},Arbiter.prototype.applyImpulse=function(){var a=this.body_a,b=this.body_b,c=this.surface_vr,d=this.u;for(var e=0;e<this.contacts.length;e++){var f=this.contacts[e],g=f.nMass,h=f.n,i=f.r1,j=f.r2,k=vadd(a.v_bias,vmult(vperp(i),a.w_bias)),l=vadd(b.v_bias,vmult(vperp(j),b.w_bias)),m=relative_velocity(a,b,i,j),n=vdot(vsub(l,k),h),o=vdot(m,h),p=vdot(vadd(m,c),vperp(h)),q=(f.bias-n)*g,r=f.jBias;f.jBias=Math.max(r+q,0);var s=-(f.bounce+o)*g,t=f.jnAcc;f.jnAcc=Math.max(t+s,0);var u=d*f.jnAcc,w=-p*f.tMass,x=f.jtAcc;f.jtAcc=clamp(x+w,-u,u),apply_bias_impulses(a,b,i,j,vmult(h,f.jBias-r)),apply_impulses(a,b,i,j,vrotate(h,v(f.jnAcc-t,f.jtAcc-x)))}},Arbiter.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},Arbiter.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var NONE=[],circle2circleQuery=function(a,b,c,d){var e=c+d,f=vsub(b,a),g=vlengthsq(f);if(g>=e*e)return;var h=Math.sqrt(g);return new Contact(vadd(a,vmult(f,.5+(c-.5*e)/(h?h:Infinity))),h?vmult(f,1/h):new Vect(1,0),h-e,0)},circle2circle=function(a,b){var c=circle2circleQuery(a.tc,b.tc,a.r,b.r);return c?[c]:NONE},circle2segment=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=vsub(d,c),g=clamp01(vdot(f,vsub(e,c))/vlengthsq(f)),h=vadd(c,vmult(f,g)),i=circle2circleQuery(e,h,a.r,b.r,con);if(i){var j=i.n;return g===0&&vdot(j,b.a_tangent)<0||g===1&&vdot(j,b.b_tangent)<0?NONE:[i]}return NONE},last_MSA_min=0,findMSA=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;e<b.length;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return last_MSA_min=d,c},findVertsFallback=function(a,b,c,d){var e=[];for(var f=0;f<a.tVerts.length;f++){var g=a.tVerts[f];b.containsVertPartial(g,vneg(c))&&e.push(new Contact(g,c,d,hashPair(a.hashid,f)))}for(var f=0;f<b.tVerts.length;f++){var g=b.tVerts[f];a.containsVertPartial(g,c)&&e.push(new Contact(g,c,d,hashPair(b.hashid,f)))}return e},findVerts=function(a,b,c,d){var e=[];for(var f=0;f<a.tVerts.length;f++){var g=a.tVerts[f];b.containsVert(g)&&e.push(new Contact(g,c,d,hashPair(a.hashid,f)))}for(var f=0;f<b.tVerts.length;f++){var g=b.tVerts[f];a.containsVert(g)&&e.push(new Contact(g,c,d,hashPair(b.hashid,f)))}return e.length?e:findVertsFallback(a,b,c,d)},poly2poly=function(a,b){var c=findMSA(b,a.tAxes);if(c==-1)return 0;var d=last_MSA_min,e=findMSA(a,b.tAxes);if(e==-1)return 0;var f=last_MSA_min;return d>f?findVerts(a,b,a.tAxes[c].n,d):findVerts(a,b,vneg(b.tAxes[e].n),f)},segValueOnAxis=function(a,b,c){var d=vdot(b,a.ta)-a.r,e=vdot(b,a.tb)-a.r;return Math.min(d,e)-c},findPointsBehindSeg=function(a,b,c,d,e){var f=vcross(b.tn,b.ta),g=vcross(b.tn,b.tb),h=vmult(b.tn,e);for(var i=0;i<c.tVerts.length;i++){var j=c.tVerts[i];if(vdot(j,h)<vdot(b.tn,b.ta)*e+b.r){var k=vcross(b.tn,j);f>=k&&k>=g&&a.push(new Contact(j,h,d,hashPair(c.hashid,i)))}}},seg2poly=function(a,b){var c=[],d=b.tAxes,e=d.length,f=vdot(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,h=b.valueOnAxis(vneg(a.tn),-f)-a.r;if(h>0||g>0)return NONE;var i=0,j=segValueOnAxis(a,d[0].n,d[0].d);if(j>0)return NONE;for(var k=0;k<e;k++){var l=segValueOnAxis(a,d[k].n,d[k].d);if(l>0)return NONE;l>j&&(j=l,i=k)}var m=vneg(d[i].n),n=vadd(a.ta,vmult(m,a.r)),o=vadd(a.tb,vmult(m,a.r));b.containsVert(n)&&c.push(new Contact(n,m,j,hashPair(a.hashid,0))),b.containsVert(o)&&c.push(new Contact(o,m,j,hashPair(a.hashid,1)));if(g>=j||h>=j)g>h?findPointsBehindSeg(c,a,b,g,1):findPointsBehindSeg(c,a,b,h,-1);if(c.length===0){var p=b.tVerts[i],q=b.tVerts[(i+1)%e],r;if(r=circle2circleQuery(a.ta,p,a.r,0,c))return[r];if(r=circle2circleQuery(a.tb,p,a.r,0,c))return[r];if(r=circle2circleQuery(a.ta,q,a.r,0,c))return[r];if(r=circle2circleQuery(a.tb,q,a.r,0,c))return[r]}return c},circle2poly=function(a,b){var c=b.tAxes,d=0,e=vdot(c[0].n,a.tc)-c[0].d-a.r;for(var f=0;f<c.length;f++){var g=vdot(c[f].n,a.tc)-c[f].d-a.r;if(g>0)return NONE;g>e&&(e=g,d=f)}var h=c[d].n,i=b.tVerts[d],j=b.tVerts[(d+1)%b.tVerts.length],k=vcross(h,i),l=vcross(h,j),m=vcross(h,a.tc);if(m<l){var n=circle2circleQuery(a.tc,j,a.r,0,n);return n?[n]:NONE}if(m<k)return[new Contact(vsub(a.tc,vmult(h,a.r+e/2)),vneg(h),e,0)];var n=circle2circleQuery(a.tc,i,a.r,0,n);return n?[n]:NONE};CircleShape.prototype.collisionCode=0,SegmentShape.prototype.collisionCode=1,PolyShape.prototype.collisionCode=2,CircleShape.prototype.collisionTable=[circle2circle,circle2segment,circle2poly],SegmentShape.prototype.collisionTable=[function(a,b){return circle2segment(b,a)},function(a,a){return NONE},seg2poly],PolyShape.prototype.collisionTable=[function(a,b){return circle2poly(b,a)},function(a,b){return seg2poly(b,a)},poly2poly];var collideShapes=exports.collideShapes=function(a,b){return a.collisionTable[b.collisionCode](a,b)},getShapeBB=function(a){return a.bb},shapeVelocityFunc=function(a){return a.body.v},defaultCollisionHandler=new CollisionHandler,Space=exports.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new BBTree(getShapeBB,null),this.activeShapes=new BBTree(getShapeBB,staticShapes),this.activeShapes.velocityfunc=shapeVelocityFunc,this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=defaultCollisionHandler,this.postStepCallbacks=[],this.iterations=10,this.gravity=vzero,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=Infinity,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1
,this.staticBody=new Body,this.collideShapes=this.makeCollideShapes()};Space.prototype.isLocked=function(){return this.locked};var assertSpaceUnlocked=function(a){assert(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};Space.prototype.addCollisionHandler=function(a,b,c,d,e,f){assertSpaceUnlocked(this),this.removeCollisionHandler(a,b);var g=new CollisionHandler;g.a=a,g.b=b,c&&(g.begin=c),d&&(g.preSolve=d),e&&(g.postSolve=e),f&&(g.separate=f),this.collisionHandlers[hashPair(a,b)]=g},Space.prototype.removeCollisionHandler=function(a,b){cpAssertSpaceUnlocked(this),delete this.collisionHandlers[hashPair(a,b)]},Space.prototype.setDefaultCollisionHandler=function(a,b,c,d){cpAssertSpaceUnlocked(this);var e=new CollisionHandler;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},Space.prototype.lookupHandler=function(a,b){return this.collisionHandlers[hashPair(a,b)]||this.defaultCollisionHandler},Space.prototype.addShape=function(a){var b=a.body;return b.isStatic()?this.addStaticShape(a):(assert(!a.space,"This shape is already added to a space and cannot be added to another."),assertSpaceUnlocked(this),b.activate(),b.addShape(a),a.update(b.p,b.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},Space.prototype.addStaticShape=function(a){assert(!a.space,"This shape is already added to a space and cannot be added to another."),assertSpaceUnlocked(this);var b=a.body;return b.addShape(a),a.update(b.p,b.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},Space.prototype.addBody=function(a){return assert(!cpBodyIsStatic(a),"Static bodies cannot be added to a space as they are not meant to be simulated."),assert(!a.space,"This body is already added to a space and cannot be added to another."),assertSpaceUnlocked(this),this.bodies.push(a),a.space=this,a},Space.prototype.addConstraint=function(a){assert(!a.space,"This shape is already added to a space and cannot be added to another."),assertSpaceUnlocked(this);var b=a.a,c=a.b;return b.activate(),c.activate(),this.constraints.push(a),a.next_a=b.constraintList,b.constraintList=a,a.next_b=c.constraintList,c.constraintList=a,a.space=this,a},Space.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];if(a===d.body_a&&(b===d.a||b===null)||a===d.body_b&&(b===d.b||b===null))b&&d.state!=="cached"&&d.callSeparate(this),d.unthread(),deleteObjFromList(this.arbiters,d),delete this.cachedArbiters[c]}},Space.prototype.removeShape=function(a){var b=a.body;b.isStatic()?this.removeStaticShape(a):(assert(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),assertSpaceUnlocked(this),b.activate(),b.removeShape(a),this.filterArbiters(b,a),this.activeShapes.remove(a,a.hashid),a.space=null)},Space.prototype.removeStaticShape=function(a){assert(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),assertSpaceUnlocked(this);var b=a.body;b.isStatic()&&b.activateStatic(a),b.removeShape(a),this.filterArbiters(b,a),this.staticShapes.remove(a,a.hashid),a.space=null},Space.prototype.removeBody=function(a){assert(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),assertSpaceUnlocked(this),a.activate(),deleteObjFromList(this.bodies,a),a.space=null},Space.prototype.removeConstraint=function(a){assert(space.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),assertSpaceUnlocked(this),a.a.activate(),a.b.activate(),deleteObjFromList(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},Space.prototype.containsShape=function(a){return a.space===this},Space.prototype.containsBody=function(a){return a.space==this},Space.prototype.containsConstraint=function(a){return a.space==this},Space.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[hashPair(a.a.hashid,a.b.hashid)],deleteObjFromList(this.arbiters,a)},Space.prototype.eachBody=function(a){this.lock();var b=this.bodies;for(var c=0;c<b.length;c++)a(b[c]);var d=this.sleepingComponents;for(var c=0;c<d.length;c++){var e=d[c],f=e;while(f){var g=f.nodeNext;a(f),f=g}}this.unlock(!0)},Space.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},Space.prototype.eachConstraint=function(a){this.lock();var b=this.constraints;for(var c=0;c<b.length;c++)a(b[c]);this.unlock(!0)},Space.prototype.reindexStatic=function(){assert(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},Space.prototype.reindexShape=function(a){assert(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var b=a.body;a.update(b.p,b.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},Space.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},Space.prototype.useSpatialHash=function(a,b){throw new Error("Spatial Hash not yet implemented!");var c,d},Space.prototype.activateBody=function(c){assert(!c.isRogue(),"Internal error: Attempting to activate a rogue body.");if(this.locked)this.rousedBodies.indexOf(c)===-1&&this.rousedBodies.push(c);else{this.bodies.push(c);for(var d=0;d<c.shapeList.length;d++){var e=c.shapeList[d];this.staticShapes.remove(e,e.hashid),this.activeShapes.insert(e,e.hashid)}for(var f=c.arbiterList;f;f=f.next(c)){var g=f.body_a;if(c===g||g.isStatic())this.cachedArbiters[hashPair(a.hashid,b.hashid)]=f,f.stamp=this.stamp,f.handler=this.lookupHandler(a.collision_type,b.collision_type),this.arbiters.push(f)}for(var h=c.constraintList;h;h=h.nodeNext){var g=h.a;(c===g||g.isStatic())&&this.constraints.push(h)}}},Space.prototype.deactivateBody=function(a){assert(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),deleteObjFromList(this.bodies,a);for(var b=0;b<a.shapeList.length;b++){var c=a.shapeList[b];this.activeShapes.remove(c,c.hashid),this.staticShapes.insert(c,c.hashid)}for(var d=a.arbiterList;d;d=d.next(a)){var e=d.body_a;(a===e||e.isStatic())&&this.uncacheArbiter(d)}for(var f=a.constraintList;f;f=f.nodeNext){var e=f.a;(a===e||e.isStatic())&&deleteObjFromList(this.constraints,f)}};var componentRoot=function(a){return a?a.nodeRoot:null},componentActivate=function(a){if(!a||!a.isSleeping(a))return;assert(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");var b=a.space,c=a;while(c){var d=c.nodeNext;c.nodeIdleTime=0,c.nodeRoot=null,c.nodeNext=null,b.activateBody(c),c=d}deleteObjFromList(b.sleepingComponents,a)};Body.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,componentActivate(componentRoot(this)))},Body.prototype.activateStatic=function(a){assert(body.isStatic(this),"Body.activateStatic() called on a non-static body.");for(var b=this.arbiterList;b;b=b.next(this))(!a||a==b.a||a==b.b)&&(b.body_a==this?b.body_b:b.body_a).activate()},Body.prototype.pushArbiter=function(a){assertSoft(a.threadForBody(this).next===null,"Internal Error: Dangling contact graph pointers detected. (A)"),assertSoft(a.threadForBody(this).prev===null,"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;assertSoft(b===null||b.threadForBody(this).prev===null,"Internal Error: Dangling contact graph pointers detected. (C)"),a.threadForBody(this).next=b,b&&(b.threadForBody(this).prev=a),this.arbiterList=a};var componentAdd=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},floodFillComponent=function(a,b){if(!b.isRogue()){var c=componentRoot(b);if(c==null){componentAdd(a,b);for(var d=b.arbiterList;d;d=d.next(b))floodFillComponent(a,b==d.body_a?d.body_b:d.body_a);for(var e=b.constraintList;e;e=e.nodeNext)floodFillComponent(a,b==e.a?e.b:e.a)}else assertSoft(c===a,"Internal Error: Inconsistency detected in the contact graph.")}},componentActive=function(a,b){for(var c=a;c;c=c.nodeNext)if(c.nodeIdleTime<b)return!0;return!1};Space.prototype.processComponents=function(a){var b=this.idleSpeedThreshold,c=b?b*b:vlengthsq(this.gravity)*a*a,d=this.bodies;for(var e=0;e<d.length;e++){var f=d[e],g=c?f.m*c:0;f.nodeIdleTime=f.kineticEnergy()>g?0:f.nodeIdleTime+a,assertSoft(f.nodeNext===null,"Internal Error: Dangling next pointer detected in contact graph."),assertSoft(f.nodeRoot===null,"Internal Error: Dangling root pointer detected in contact graph.")}var h=this.arbiters;for(var e=0,i=h.length;e<i;e++){var j=h[e],k=j.body_a,l=j.body_b;(l.isRogue()&&!l.isStatic()||k.isSleeping())&&k.activate(),(k.isRogue()&&!k.isStatic()||l.isSleeping())&&l.activate(),k.pushArbiter(j),l.pushArbiter(j)}var m=this.constraints;for(var e=0;e<m.length;e++){var n=m[e],k=n.a,l=n.b;l.isRogue()&&!l.isStatic()&&k.activate(),k.isRogue()&&!k.isStatic()&&l.activate()}for(var e=0;e<d.length;){var f=d[e];if(componentRoot(f)===null){floodFillComponent(f,f);if(!componentActive(f,this.sleepTimeThreshold)){this.sleepingComponents.push(f);for(var o=f;o;o=o.nodeNext)this.deactivateBody(o);continue}}e++,f.nodeRoot=null,f.nodeNext=null}},Body.prototype.sleep=function(){this.sleepWithGroup(null)},Body.prototype.sleepWithGroup=function(a){assert(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var b=this.space;assert(b,"Cannot put a rogue body to sleep."),assert(!b.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),assert(a===null||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier.");if(this.isSleeping()){assert(componentRoot(this)===componentRoot(a),"The body is already sleeping and it's group cannot be reassigned.");return}for(var c=0;c<body.shapeList.length;c++)body.shapeList.update(this.p,this.rot);b.deactivateBody(this);if(a){var d=componentRoot(a);this.nodeRoot=d,this.nodeNext=d.nodeNext,this.nodeIdleTime=0,d.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,b.sleepingComponents.push(this);deleteObjFromList(b.bodies,this)},Space.prototype.activateShapesTouchingShape=function(a){this.sleepTimeThreshold!==Infinity&&this.shapeQuery(a,function(a,b){a.body.activate()})},Space.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)};this.lock(),this.activeShapes.pointQuery(a,e),this.staticShapes.pointQuery(a,e),this.unlock(!0)},Space.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},Space.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},Space.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&g.t<e.t&&(e=g),e.t};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e.t,f),e},Space.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&bbIntersects(a,e.bb)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},Space.prototype.shapeQuery=function(a,b){var c=a.body,d=c?a.update(c.p,c.rot):a.bb,e=!1,f=function(c){var d=a;if(d.group&&d.group===c.group||!(d.layers&c.layers)||d===c)return;var f;if(d.collisionCode<=c.collisionCode)f=cpCollideShapes(d,c);else{f=cpCollideShapes(c,d);for(var g=0;g<f.length;g++)f[g].n=vneg(f[g].n)}if(f.length){e=!d.sensor&&!c.sensor;if(b){var h=new Array(f.length);for(var g=0;g<f.length;g++)h[g]=new ContactPoint(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},Space.prototype.addPostStepCallback=function(a){assertWarn(space.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},Space.prototype.runPostStepCallbacks=function(){for(var a=0;a<this.postStepCallbacks.length;a++)this.postStepCallbacks[a]()},Space.prototype.lock=function(){this.locked++},Space.prototype.unlock=function(a){this.locked--,assert(this.locked>=0,"Internal Error: Space lock underflow.");if(!this.locked&&a){var b=space.rousedBodies;for(var c=0;c<b.length;c++)this.activateBody(b[c]);b.length=0,this.runPostStepCallbacks()}},Space.prototype.makeCollideShapes=function(){var a=this;return function(a,b){var c=c;if(!bbIntersects(a.bb,b.bb)||a.body===b.body||a.group&&a.group===b.group||!(a.layers&b.layers))return;var d=c.lookupHandler(a.collision_type,b.collision_type),e=a.sensor||b.sensor;if(e&&d===defaultCollisionHandler)return;var f=collideShapes(a,b);if(f.length===0)return;var g=hashPair(a.hashid,b.hashid),h=c.cachedArbiters[g];h||(h=c.cachedArbiters[g]=new Arbiter(a,b)),h.update(f,d,a,b),h.state=="first coll"&&!d.begin(h,c)&&h.ignore(),h.state!=="ignore"&&d.preSolve(h,c)&&!e?c.arbiters.push(h):(h.contacts=null,h.state!=="ignore"&&(h.state="normal")),h.stamp=c.stamp}},Space.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&a.state!="cached"&&(cpArbiterCallSeparate(a,this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var updateFunc=function(a){var b=a.body;a.update(b.p,b.rot)};Space.prototype.step=function(a){if(a===0)return;this.stamp++;var b=this.curr_dt;this.curr_dt=a;var c=this.bodies,d=this.constraints,e=this.arbiters;for(var f=0;f<e.length;f++){var g=e[f];g.state="normal",!g.body_a.isSleeping()&&!g.body_b.isSleeping()&&g.unthread()}e.length=0,this.lock();for(var f=0;f<c.length;f++){var h=c[f];h.position_func(a)}this.activeShapes.each(updateFunc),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),(this.sleepTimeThreshold!=Infinity||this.enableContactGraph)&&this.processComponents(a),this.lock();for(var i in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[i])||delete this.cachedArbiters[i];var j=this.collisionSlop,k=1-Math.pow(this.collisionBias,a);for(var f=0;f<e.length;f++)e[f].preStep(a,j,k);for(var f=0;f<d.length;f++){var l=d[f];l.preSolve(this),l.preStep(a)}var m=Math.pow(this.damping,a),n=this.gravity;for(var f=0;f<c.length;f++){var h=c[f];h.velocity_func(n,m,a)}var o=b===0?0:a/b;for(var f=0;f<e.length;f++)e[f].applyCachedImpulse(o);for(var f=0;f<d.length;f++){var l=d[f];l.applyCachedImpulse(o)}for(var f=0;f<this.iterations;f++){for(var p=0;p<e.length;p++)e[p].applyImpulse();for(var p=0;p<d.length;p++)d[p].applyImpulse()}for(var f=0;f<d.length;f++)d[f].postSolve(this);for(var f=0;f<e.length;f++){var g=e[f];g.handler.postSolve(g,this)}this.unlock(!0)};var relative_velocity=function(a,b,c,d){var e=vadd(a.v,vmult(vperp(c),a.w)),f=vadd(b.v,vmult(vperp(d),b.w));return vsub(f,e)},normal_relative_velocity=function(a,b,c,d,e){return vdot(relative_velocity(a,b,c,d),e)},apply_impulse=function(a,b,c){a.v=vadd(a.v,vmult(b,a.m_inv)),a.w+=a.i_inv*vcross(c,b)},apply_impulses=function(a,b,c,d,e){apply_impulse(a,vneg(e),c),apply_impulse(b,e,d)},apply_bias_impulse=function(a,b,c){a.v_bias=vadd(a.v_bias,vmult(b,a.m_inv)),a.w_bias+=a.i_inv*vcross(c,b)},apply_bias_impulses=function(a,b,c,d,e){apply_bias_impulse(a,vneg(e),c),apply_bias_impulse(b,e,d)},k_scalar_body=function(a,b,c){var d=vcross(b,c);return a.m_inv+a.i_inv*d*d},k_scalar=function(a,b,c,d,e){var f=k_scalar_body(a,c,e)+k_scalar_body(b,d,e);return assertSoft(f!==0,"Unsolvable collision or constraint."),f},k_tensor=function(a,b,c,d){var e,f,g,h,i=a.m_inv+b.m_inv;e=i,f=0,g=0,h=i;var j=a.i_inv,k=c.x*c.x*j,l=c.y*c.y*j,m=-c.x*c.y*j;e+=l,f+=m,g+=m,h+=k;var n=b.i_inv,o=d.x*d.x*n,p=d.y*d.y*n,q=-d.x*d.y*n;e+=p,f+=q,g+=q,h+=o;var r=e*h-f*g;assertSoft(r!==0,"Unsolvable constraint.");var s=1/r;return[new Vect(h*s,-f*s),new Vect(-g*s,e*s)]},mult_k=function(a,b,c){return new Vect(vdot(a,b),vdot(a,c))},bias_coef=function(a,b){return 1-Math.pow(a,b)},Constraint=exports.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=Infinity,this.errorBias=fpow(.9,60),this.maxBias=Infinity};Constraint.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},Constraint.prototype.preStep=function(a){},Constraint.prototype.applyCachedImpulse=function(a){},Constraint.prototype.applyImpulse=function(){},Constraint.prototype.getImpulse=function(){return 0},Constraint.prototype.preSolve=function(a){},Constraint.prototype.postSolve=function(a){}